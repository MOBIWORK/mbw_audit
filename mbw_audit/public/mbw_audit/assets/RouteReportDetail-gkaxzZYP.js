import{r as c,j as t,S as h,e as ee,f as Ie,u as be,A as O,s as te,H as Ee,g as Ae,T as B,D as Re,d as $e}from"./main-zCkGqYJs.js";import{V as Te,e as ne,F as Ne}from"./FileSaver.min-IRLO_gjY.js";import{C as w,a as I}from"./CloseCircleOutlined-tJ1NIynM.js";import{I as le}from"./index-RNFChjy2.js";const{RangePicker:Oe}=Re;function ke(){const[y,z]=c.useState("all"),[_,ae]=c.useState([]),[x,ie]=c.useState("all"),[S,se]=c.useState("all"),[j,re]=c.useState("all"),[b,M]=c.useState(null);c.useState(!1);const[F,De]=c.useState([{label:"Đạt",value:1},{label:"Không đạt",value:0}]),[E,k]=c.useState(!1),[H,K]=c.useState([{title:"STT",dataIndex:"stt",width:50},{title:"Khách hàng",dataIndex:"customer_name",width:100},{title:"Tên chiến dịch",dataIndex:"campaign_name",width:100},{title:"Nhân viên thực hiện",dataIndex:"employee_name",width:100},{title:"Số lượng danh mục",dataIndex:"quantity_cate",width:100},{title:"Số lượng sản phẩm AI đếm",children:[],width:300},{title:"Số lượng sản phẩm giám sát đếm",children:[],width:300},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let n=[];if(e!==null)try{n=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return t.jsx("a",{style:{cursor:n.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),n.length>0&&$(e)},children:n.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let n=[];if(e!==null)try{n=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return t.jsx("a",{style:{cursor:n.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),n.length>0&&$(e)},children:n.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const n=new Date(e),a=n.getDate(),l=n.getMonth()+1,s=n.getFullYear(),o=n.getHours(),d=n.getMinutes(),r=`${a.toString().padStart(2,"0")}/${l.toString().padStart(2,"0")}/${s} ${o.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`;return t.jsx("div",{children:r})},width:120},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]}),width:120},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,n,a)=>t.jsx("div",{onClick:l=>{l.stopPropagation()},children:t.jsxs(h,{defaultValue:e,onChange:()=>q(n),bordered:b===a,onMouseEnter:()=>W(a),onMouseLeave:U,suffixIcon:b===a?t.jsx(ee,{}):null,children:[t.jsx(h.Option,{value:1,children:t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),t.jsx(h.Option,{value:0,children:t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})}),width:120}]),[D,J]=c.useState([]),{search:oe}=Ie();new URLSearchParams(oe).get("campaign");const de=be(),[A,L]=c.useState([]),[ce,he]=c.useState([]),[ge,V]=c.useState([]),X=e=>{localStorage.setItem("recordData",JSON.stringify(e)),localStorage.setItem("dataReports",JSON.stringify(A)),de("/report-view")};c.useEffect(()=>{xe(),fe()},[]);const me=[{title:"STT",dataIndex:"stt",fixed:"left",width:"5%"},{title:"Khách hàng",dataIndex:"customer_name",fixed:"left"},{title:"Tên chiến dịch",dataIndex:"campaign_name",fixed:"left"},{title:"Nhân viên thực hiện",dataIndex:"employee_name"},{title:"Số lượng danh mục",dataIndex:"quantity_cate"},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let n=[];if(e!==null)try{n=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return t.jsx("a",{style:{cursor:n.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),n.length>0&&$(e)},children:n.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let n=[];if(e!==null)try{n=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return t.jsx("a",{style:{cursor:n.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),n.length>0&&$(e)},children:n.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const n=new Date(e),a=n.getDate(),l=n.getMonth()+1,s=n.getFullYear(),o=n.getHours(),d=n.getMinutes(),r=`${a.toString().padStart(2,"0")}/${l.toString().padStart(2,"0")}/${s} ${o.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`;return t.jsx("div",{children:r})}},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,n,a)=>t.jsx("div",{onClick:l=>{l.stopPropagation()},children:t.jsxs(h,{defaultValue:e,onChange:()=>q(n),bordered:b===a,onMouseEnter:()=>W(a),onMouseLeave:U,suffixIcon:b===a?t.jsx(ee,{}):null,children:[t.jsx(h.Option,{value:1,children:t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),t.jsx(h.Option,{value:0,children:t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})})}],pe=[{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Số lượng sản phẩm AI đếm",dataIndex:"sum_product"},{title:"Số lượng sản phẩm giám sát đếm",dataIndex:"sum_product_human"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}],ue=async()=>{const e=JSON.parse(localStorage.getItem("campaign_dashboard"));e&&(z(e.campaign_code),k(!0),localStorage.removeItem("campaign_dashboard"));let n="/api/method/mbw_audit.api.api.get_reports_by_filter";if(y!=null&&y!=""&&y!="all"&&(n=`${n}?campaign_code=${y}`),_!=null&&_.length==2){let l=Math.round(new Date(_[0]).getTime()/1e3),s=Math.round(new Date(_[1]).getTime()/1e3);n.includes("?")?n=`${n}&start_date=${l}&end_date=${s}`:n=`${n}?start_date=${l}&end_date=${s}`}x!=null&&x!=""&&x!="all"&&(n.includes("?")?n=`${n}&employee_id=${x}`:n=`${n}?employee_id=${x}`),S!=null&&S!="all"&&(n.includes("?")?n=`${n}&status_scoring_ai=${S}`:n=`${n}?status_scoring_ai=${S}`,console.log(n)),j!=null&&j!="all"&&(n.includes("?")?n=`${n}&status_scoring_human=${j}`:n=`${n}?status_scoring_human=${j}`);let a=await O.get(n);if(a!=null&&a.message=="ok"&&a.result!=null&&a.result.data!=null){let l=a.result.data.map((s,o)=>{let d=(o+1).toString().padStart(2,"0"),r=JSON.parse(s.categories).length.toString().padStart(2,"0");return{...s,key:s.name,stt:d,quantity_cate:r}});if(!E)L(l);else{let s=!1,o=[],d=[];for(let r=0;r<l.length;r++){for(let i=0;i<l[r].info_products_ai.length;i++){if(!s){let f={title:l[r].info_products_ai[i].product_name,dataIndex:`${l[r].info_products_ai[i].product_name}_ai`,key:`${l[r].info_products_ai[i].product_name}_ai`,width:100},m={title:l[r].info_products_ai[i].product_name,dataIndex:`${l[r].info_products_ai[i].product_name}_human`,key:`${l[r].info_products_ai[i].product_name}_human`,width:100};o.push(f),d.push(m)}l[r][`${l[r].info_products_ai[i].product_name}_ai`]=l[r].info_products_ai[i].sum,l[r][`${l[r].info_products_human[i].product_name}_human`]=l[r].info_products_human[i].sum}o.length>0&&(s=!0)}K(r=>(r[5].children=o,r[6].children=d,r)),J(l)}}else E?(K(l=>(l[5].children=[],l[6].children=[],l)),J([])):L([])},W=e=>{M(e)},U=()=>{M(!1)},q=async e=>{const n=e.scoring_human===1?0:1;let a={name:e.name,scoring_human:n};const s=await O.post("/api/method/mbw_audit.api.api.update_scorehuman_by_name",a);s!=null&&s.message=="ok"&&s.result!=null&&s.result.data=="success"?te.success("Cập nhật thành công"):te.error("Cập nhật thất bại")},xe=async()=>{try{const n=await O.get("/api/method/mbw_service_v2.api.ess.employee.get_list_employee");n&&n.result&&n.result.data&&he(n.result.data)}catch(e){console.error("Error fetching employee data:",e)}},fe=async()=>{const n=await O.get("/api/method/mbw_audit.api.api.get_all_campaigns");n!=null&&n.message=="ok"&&n.result!=null?V(n.result.data):V([])};c.useEffect(()=>{ue()},[y,_,x,S,j]);const ye=()=>{E?_e(D,H):Se(A,"Báo cáo chấm điểm trưng bày")},P=(e,n=!1)=>{const a={font:{bold:!0,name:"Times New Roman",size:12},alignment:{vertical:"middle",horizontal:"center"}};n&&(a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}),e.style=a},_e=async(e,n,a)=>{console.log(e),console.log(n);const l=new ne.Workbook,s=l.addWorksheet("Sheet1");let o=1;n.forEach((i,f)=>{const m=o;o===1?s.getColumn(o).width=10:s.getColumn(o).width=i.width||20;const u=s.getCell(1,o);if(u.value=i.title,P(u,!0),i.children&&i.children.length>0){const g=i.children.length;u.isMerged||s.mergeCells(1,o,1,o+g-1),i.children.forEach((C,T)=>{const Z=m+T,v=s.getCell(2,Z);v.value=C.title,P(v)}),o+=g}else o++});const d=3;e.forEach((i,f)=>{o=1,n.forEach((m,u)=>{const g=m.dataIndex;let p=i[g];if(m.children&&m.children.length>0)return;if(g.endsWith("_ai")||g.endsWith("_human")){const[T,Z]=m.title.split(" "),v=i[T.toLowerCase()];v&&Array.isArray(v)&&(p=v.filter(N=>N.product_name===T).map(N=>`${N.product_name}: ${N.sum}`).join(`
`))}const C=s.getCell(d+f,o);C.value=p,P(C,!1),o++})});const r=await l.xlsx.writeBuffer();G(r,"report")},Se=async(e,n)=>{const a=new ne.Workbook,l=a.addWorksheet("Sheet1");l.properties.defaultColWidth=20,l.getColumn("A").width=30,l.mergeCells("A2:J2"),l.getCell("A2").value=n,l.getCell("A2").style={font:{bold:!0,name:"Times New Roman",size:12}},l.getCell("A2").alignment={vertical:"middle",horizontal:"center"};let s=l.getRow(4),o=l.getRow(5),d=[{title:"Khách hàng",field:"customer_name"},{title:"Tên chiến dịch",field:"campaign_name"},{title:"Nhân viên thực hiện",field:"employee_name"},{title:"Số lượng danh mục",field:"categories"},{title:"Ảnh gian hàng",field:"images"},{title:"Ảnh gian hàng AI",field:"images_ai"},{title:"Thời gian thực hiện",field:"images_time"},{title:"Điểm trưng bày AI chấm",field:"scoring_machine"},{title:"Điểm trưng bày giám sát chấm",field:"scoring_human"}];for(let i=0;i<d.length;i++){let f=s.getCell(i+1),m=o.getCell(i+1);l.mergeCells(`${f._address}:${m._address}`),s.getCell(i+1).style={font:{bold:!0,name:"Times New Roman",size:12,italic:!0}},s.getCell(i+1).alignment={vertical:"middle",horizontal:"center"},s.getCell(i+1).value=d[i].title}for(let i=0;i<e.length;i++){let m=l.getRow(i+6),u=1;for(let g=0;g<d.length;g++){m.getCell(u).style={font:{name:"Times New Roman",size:12,italic:!0}};let p="";d[g].field=="categories"?e[i][d[g].field]!=null&&e[i][d[g].field]!=""&&(p=JSON.parse(e[i][d[g].field]).length):d[g].field=="scoring_machine"||d[g].field=="scoring_human"?e[i][d[g].field]==0?p="Không đạt":p="Đạt":p=e[i][d[g].field],m.getCell(u).value=p,u+=1}}const r=await a.xlsx.writeBuffer();G(r,"report")},G=(e,n)=>{let a="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8",l=".xlsx";const s=new Blob([e],{type:a});Ne.saveAs(s,n+"_export_"+new Date().getTime()+l)},je=e=>{z(e),e=="all"?k(!1):k(!0)},[ve,Y]=c.useState([]),[Ce,Q]=c.useState(!1),we=e=>{Q(!1),Y([])},R=(e,n)=>(n?.children??"").toLowerCase().includes(e.toLowerCase()),$=e=>{const n=JSON.parse(e);Y(n),Q(!0)};return t.jsxs(t.Fragment,{children:[t.jsx(Ee,{title:"Báo cáo",buttons:[{label:"Xuất dữ liệu",type:"primary",icon:t.jsx(Te,{className:"text-xl"}),size:"20px",className:"flex items-center",action:ye}]}),t.jsxs("div",{className:"bg-white rounded-xl",children:[t.jsxs("div",{className:"flex p-4",style:{alignItems:"flex-end"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",paddingRight:"15px"},children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Chiến dịch:"}),t.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:y,onChange:e=>je(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[t.jsx(h.Option,{value:"all",children:"Tất cả"}),ge.map(e=>t.jsx(h.Option,{value:e.name,children:e.campaign_name},e.name))]})]}),t.jsx(Ae,{className:"w-[250px] border-none mr-4",label:"Thời gian thực hiện",children:t.jsx(Oe,{value:_,onChange:e=>ae(e)})}),t.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Nhân viên:"}),t.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:x,onChange:e=>ie(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[t.jsx(h.Option,{value:"all",children:"Tất cả"}),ce.map(e=>t.jsx(h.Option,{value:e.name,children:e.employee_name},e.name))]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm AI chấm:"}),t.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:S,onChange:e=>se(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[t.jsx(h.Option,{value:"all",children:"Tất cả"}),F.map(e=>t.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm giám sát chấm:"}),t.jsxs(h,{className:"w-[150px] h-[36px]",value:j,onChange:e=>re(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",showSearch:!0,children:[t.jsx(h.Option,{value:"all",children:"Tất cả"}),F.map(e=>t.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]})]}),t.jsx("div",{children:E?t.jsx(B,{bordered:!0,columns:H,dataSource:D,pagination:D.length>5,scroll:{y:540,x:2e3},onRow:(e,n)=>({onClick:()=>X(e)}),rowHoverBg:"#f0f0f0"}):t.jsx(B,{bordered:!0,columns:me,dataSource:A,scroll:{y:540,x:1300},pagination:A.length>5,onRow:(e,n)=>({onClick:()=>X(e)}),rowHoverBg:"#f0f0f0",expandable:{expandedRowRender:(e,n)=>t.jsx("div",{style:{margin:5},children:t.jsx(B,{columns:pe,dataSource:e.detail_skus,pagination:!1})})}})})]}),t.jsx(le.PreviewGroup,{preview:{visible:Ce,onVisibleChange:we},children:ve.map((e,n)=>t.jsx(le,{style:{display:"none"},width:50,src:e},n))})]})}function Ke(){return t.jsxs(t.Fragment,{children:[t.jsx($e,{children:t.jsx("title",{children:"BÁO CÁO"})}),t.jsx(ke,{})]})}export{Ke as default};
