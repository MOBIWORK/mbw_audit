import{r as n,j as e,aL as me,C as J,g as A,a2 as Y,D as ue,S as Re,L as Ve,A as Q,a4 as Z,T as K,aM as he,M as ee,a3 as te,B as ne,s as q,a7 as Ke,a1 as se,aN as pe,aO as Le,a8 as ze,u as He,F as xe,H as Be,a5 as $e,aP as Ge,aa as We,d as Ye}from"./main-i-Wvj7V3.js";const Je=[{label:"Hoạt động",value:"Open"},{label:"Đóng",value:"Close"}];function Qe({form:y,onCampaignStatusChange:b}){const[N,p]=n.useState("Open"),x=f=>{p(f),b(f)};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-4 pt-6 pb-[58px]",children:[e.jsxs(me,{children:[e.jsx(J,{span:8,children:e.jsx(A,{label:"Tên chiến dịch",name:"campaign_name",required:!0,children:e.jsx(Y,{})})}),e.jsx(J,{span:8,children:e.jsx(A,{label:"Thời gian bắt đầu",name:"campaign_start",required:!0,children:e.jsx(ue,{className:"!bg-[#F4F6F8]",showTime:!0})})}),e.jsx(J,{span:8,children:e.jsx(A,{label:"Thời gian kết thúc",name:"campaign_end",required:!0,children:e.jsx(ue,{className:"!bg-[#F4F6F8]",showTime:!0})})})]}),e.jsxs(me,{className:"pt-2",children:[e.jsx(J,{span:8,children:e.jsx(A,{label:"Trạng thái",name:"campaign_status",children:e.jsx(Re,{defaultValue:"Open",options:Je,onChange:x})})}),e.jsx(J,{span:8,children:e.jsx(A,{label:"Mô tả",name:"campaign_description",children:e.jsx(Ve,{className:"bg-[#F5F7FA]",autoSize:{minRows:3,maxRows:5}})})})]})]})})}function Ue({onChangeCategory:y,onChangeCheckExistProduct:b,onChangeCheckSequenceProduct:N,onChangeSequenceProducts:p}){const[x,f]=n.useState(!1),[E,I]=n.useState(!1),[S,w]=n.useState([]),[C,T]=n.useState([]),[j,L]=n.useState([]),[R,_]=n.useState([]),[O,F]=n.useState([]),[D,g]=n.useState([]),[P,V]=n.useState(""),[z,H]=n.useState(""),[i,c]=n.useState([]),[d,u]=n.useState([]),[h,o]=n.useState([]),[k,B]=n.useState(!0),[$,M]=n.useState(!1),[oe,ae]=n.useState([]);n.useState({}),n.useEffect(()=>{U()},[]),n.useEffect(()=>{U()},[P]);const U=async()=>{let t='/api/resource/VGM_Category?fields=["*"]';P!=null&&P!=""&&(t+=`&filters=[["category_name", "like", "%${P}%"]]`);const l=await Q.get(t);if(l&&l.data){let a=l.data.map(s=>({...s,key:s.name}));for(let s=0;s<a.length;s++){let r=`/api/resource/VGM_Product?fields=["name","product_code","product_name"]&&filters=[["category","=","${a[s].name}"]]&limit_page_length=500`,m=await Q.get(r);if(m!=null&&m.data!=null){a[s].product_num=m.data.length;let v=m.data.map(W=>({...W,key:W.name}));a[s].products=v}else a[s].product_num=0,a[s].products=[]}L(a)}},ce=t=>{V(t.target.value)},re=t=>{const l=t.target.value.toLowerCase();H(l);const a=[...O];if(l===""){_(O);return}else{const s=a.filter(r=>r.product_name.toLowerCase().includes(l));_(s)}},X=(t,l)=>{w(t)},G=(t,l)=>{const a=O.map((s,r)=>{const m=t.indexOf(s.name),v=m!==-1?m+1:null;return{...s,sequence_product:v}});_(a),T(t)},ge={selectedRowKeys:S,onChange:X},ye={selectedProductRowKeys:C,onChange:G},fe=()=>{if(S.length>1){q.error("Số lượng danh mục không được vượt quá 1 danh mục");return}let t=[],l=[];for(let a=0;a<S.length;a++){let s=j.filter(r=>r.name===S[a]);if(s!=null&&s.length>0){s[0].stt=t.length+1;let r={...s[0]};r.products=r.products.map(m=>({...m,cate_name:r.category_name,product_num:"1"})),l=l.concat(r.products),t.push(r)}}o(l),_(l),F(l),c(t),u(t),y(t),le()},Se=()=>{const t=R.filter(s=>C.includes(s.name));let l=t.map(s=>s.name);p(l);const a=t.sort((s,r)=>{const m=parseInt(s.sequence_product),v=parseInt(r.sequence_product);return m-v});g(a),de()},Ce=S.length>0,je=C.length>0,ke=()=>{f(!0)},_e=()=>{I(!0)},be=()=>{f(!1)},le=()=>{f(!1)},de=()=>{I(!1)},we=t=>{const l=i.filter(r=>r.name!==t.name).map((r,m)=>({...r,stt:m+1})),a=h.filter(r=>r.cate_name!==t.category_name);if(o(a),_(a),D.length>0){const r=D.filter(W=>W.cate_name!==t.category_name);let m=1;const v=r.map(W=>(W.sequence_product=m++,W));g(v)}F(a),c(l);const s=l.map(r=>({...r,products:r.products.filter(m=>h.some(v=>v.name===m.name))}));y(s)},Pe=t=>{t.stopPropagation(),B(t.target.checked),b(t.target.checked)},ve=t=>{M(t.target.checked),N(t.target.checked)},Ne=(t,l)=>{const a=[{title:"Mã sản phẩm",dataIndex:"product_code",key:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name",key:"product_name"}];return e.jsx(e.Fragment,{children:e.jsx("div",{style:{margin:5},children:e.jsx(Ke,{columns:a,dataSource:t.products,pagination:!1})})})},Ee=[{title:"STT",dataIndex:"stt",key:"stt"},{title:"Danh mục sản phẩm",dataIndex:"category_name",key:"category_name"},{title:"Số lượng sản phẩm",dataIndex:"product_num",key:"product_num"},{title:"",key:"",render:t=>e.jsx(se,{onClick:()=>we(t)})}],Ie=[{title:"Mã sản phẩm",dataIndex:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Danh mục",dataIndex:"cate_name"},{title:"Số lượng ít nhất",dataIndex:"product_num",render:(t,l,a)=>e.jsx(Y,{style:{width:"120px"},min:1,defaultValue:t,onChange:s=>{const r=parseInt(s.target.value);!isNaN(r)&&r>=1?ie(a,r):(q.warning("Số lượng ít nhất là 1"),ie(a,1))}})},{title:"",key:"",render:t=>e.jsx(se,{onClick:()=>Te(t)})}],Te=t=>{const l=h.filter(s=>s.name!==t.name);o(l);const a=d.map(s=>({...s,products:s.products.filter(r=>l.some(m=>m.name===r.name))}));u(a),y(a)},De=[{key:"sort"},{title:"STT",dataIndex:"sequence_product"},{title:"Mã sản phẩm",dataIndex:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Danh mục",dataIndex:"cate_name"}],ie=(t,l)=>{const a=[...h];a[t].product_num=l,o(a);const s=d.map(r=>({...r,products:r.products.filter(m=>a.some(v=>v.name===m.name))}));u(s),y(s)},qe=(t,l)=>{_(a=>a.map((s,r)=>{if(r===t){const m=s.sequence_product||0;return{...s,sequence_product:m+l}}return s}))},Oe=t=>{let l=t.map(a=>a.name);ae(l),p(l)},Fe=[{key:"1",label:e.jsxs(pe,{checked:k,onClick:t=>{t.stopPropagation()},onChange:Pe,children:[" ",e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},onClick:t=>{t.stopPropagation()},children:[" ","1. Tiêu chí tồn tại sản phẩm"]})," "]}),children:e.jsx("div",{className:"m-3",children:e.jsx(K,{columns:Ie,dataSource:h})})},{key:"2",label:e.jsxs(pe,{onClick:t=>{t.stopPropagation()},checked:$,onChange:ve,children:[" ",e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},onClick:t=>{t.stopPropagation()},children:[" ","2. Tiêu chí sắp xếp sản phẩm"]})," "]}),children:e.jsxs("div",{children:[e.jsxs("div",{onClick:_e,className:"flex justify-center h-9 cursor-pointer items-center ml-4 mt-4 mb-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px] ",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn sản phẩm"})]}),e.jsx("div",{className:"ml-4 mb-4 mr-4 mt-4",style:{fontSize:"17px",fontStyle:"italic",fontWeight:400,lineHeight:"21px",letterSpacing:"0em",textAlign:"left",color:"rgba(99, 115, 129, 1)"},children:e.jsx("span",{children:"Di chuyển (kéo, thả) các sản phẩm để sắp xếp thứ tự sản phẩm"})}),e.jsx(Le,{columnsTable:De,datasTable:D,keyPros:"sequence_product",onDragRowEvent:Oe})]})}],Me=[{key:"1",label:e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},children:[" ","Thiết lập tiêu chí chấm điểm trưng bày sản phẩm"]}),children:e.jsx(he,{items:Fe,defaultActiveKey:["1","2"],className:"custom-collapse-audit"})}],Ae=t=>{};return e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách sản phẩm"}),e.jsxs("div",{onClick:ke,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn danh mục"})]}),e.jsxs("div",{className:"pt-6 mx-4",children:[e.jsx(K,{columns:Ee,expandable:{expandedRowRender:Ne,defaultExpandedRowKeys:["0"]},dataSource:i}),e.jsx(he,{items:Me,defaultActiveKey:["1","2"],onChange:Ae,className:"custom-collapse-parent"})]}),e.jsxs(ee,{width:990,title:"Chọn danh mục sản phẩm",open:x,onOk:be,onCancel:le,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:P,onChange:ce,placeholder:"Tìm kiếm danh mục sản phẩm",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:Ce?`Đã chọn ${S.length} danh mục`:""}),e.jsx(ne,{type:"primary",onClick:fe,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:ge,columns:[{title:"Danh mục sản phẩm",dataIndex:"category_name",key:"category_name"},{title:"Số lượng sản phẩm",dataIndex:"product_num",key:"product_num"}],dataSource:j})})]}),e.jsxs(ee,{width:990,title:"Sắp xếp sản phẩm",open:E,onCancel:de,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:z,onChange:re,placeholder:"Tìm kiếm sản phẩm",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:je?`Đã chọn ${C.length} sản phẩm`:""}),e.jsx(ne,{type:"primary",onClick:Se,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:ye,scroll:{y:350},columns:[{title:"Mã sản phẩm",dataIndex:"product_code",key:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name",key:"product_name"},{title:"Danh mục",dataIndex:"cate_name",key:"cate_name"},{title:"Chọn thứ tự",dataIndex:"sequence_product",render:(t,l,a)=>e.jsx(Y,{style:{width:"120px"},defaultValue:t,value:t,onChange:s=>qe(a,parseInt(s.target.value))})}],dataSource:R})})]})]})}function Xe({onChangeCustomer:y}){const b=ze.apiUrl,[N,p]=n.useState(!1),[x,f]=n.useState([]),[E,I]=n.useState([]),[S,w]=n.useState([]),[C,T]=n.useState([]),[j,L]=n.useState(""),R=[{title:"ID",dataIndex:"customer_code",key:"customer_code"},{title:"Tên khách hàng",key:"customer_name",dataIndex:"customer_name"},{title:"Nhóm khách hàng",dataIndex:"customer_group",key:"customer_group"},{title:"Địa chỉ",key:"customer_primary_address",dataIndex:"customer_primary_address"},{title:"",key:"action",render:(c,d)=>e.jsx("a",{children:e.jsx(se,{onClick:()=>z(d)})})}];n.useEffect(()=>{_()},[]),n.useEffect(()=>{let c=S;j!=null&&j!=""&&(c=S.filter(d=>d.customer_name.toLowerCase().includes(j.toLowerCase()))),I(c)},[j]);const _=async()=>{let c=b+".api.get_list_customers";console.log(c);let d=await Q.get(c),u=[];d!=null&&d.message=="ok"&&(u=d.result.data.map(h=>({...h,key:h.name}))),I(u),w(u)},O=()=>{p(!0)},F=()=>{p(!1)},D=()=>{p(!1)},g=c=>{L(c.target.value)},P=c=>{f(c)},V=()=>{const c=[...C];for(let d=0;d<x.length;d++)if(c.filter(h=>h.name===x[d]).length===0){const h=E.filter(o=>o.name===x[d]);h!=null&&h.length>0&&c.push(h[0])}T(c),y(c),D(),f([])},z=c=>{const d=C.filter(u=>u.name!==c.name);T(d),y(d)},H={selectedRowKeys:x,onChange:P},i=x.length>0;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách khách hàng"}),e.jsxs("div",{onClick:O,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn khách hàng"})]}),e.jsx("div",{className:"pt-6 mx-4",children:e.jsx(K,{columns:R,dataSource:C})}),e.jsxs(ee,{width:990,title:"Chọn khách hàng",open:N,onOk:F,onCancel:D,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:j,onChange:g,placeholder:"Tìm kiếm tên khách hàng",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:i?`Đã chọn ${x.length} khách hàng`:""}),e.jsx(ne,{type:"primary",onClick:V,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:H,columns:[{title:"ID",dataIndex:"customer_code",key:"customer_code"},{title:"Tên khách hàng",key:"customer_name",dataIndex:"customer_name"},{title:"Nhóm khách hàng",dataIndex:"customer_group",key:"customer_group"},{title:"Địa chỉ",key:"customer_primary_address",dataIndex:"customer_primary_address"}],dataSource:E})})]})]})})}const Ze=[{title:"Mã nhân viên",dataIndex:"name",key:"name"},{title:"Tên nhân viên",dataIndex:"employee_name",key:"employee_name"},{title:"Email",dataIndex:"email",key:"email"}];function et({onChangeEmployees:y}){const[b,N]=n.useState(!1),[p,x]=n.useState([]),[f,E]=n.useState([]),[I,S]=n.useState([]),[w,C]=n.useState(""),[T,j]=n.useState([]),L=[{title:"Mã nhân viên",dataIndex:"name",key:"name"},{title:"Tên nhân viên",dataIndex:"employee_name",key:"employee_name"},{title:"Email",dataIndex:"email",key:"email"},{title:"",key:"",render:i=>e.jsx("a",{children:e.jsx(se,{onClick:()=>V(i)})})}];n.useEffect(()=>{R()},[]),n.useEffect(()=>{let i=I;w!=null&&w!=""&&(i=I.filter(c=>c.employee_name.toLowerCase().includes(w.toLowerCase()))),E(i)},[w]);const R=async()=>{let c=await Q.get("/api/method/mbw_audit.api.api.get_list_employees"),d=[];c!=null&&c.result!=null&&c.result.data!=null&&(d=c.result.data.map(u=>({...u,email:u.personal_email,key:u.name}))),E(d),S(d)},_=()=>{N(!0)},O=()=>{N(!1)},F=()=>{N(!1)},D=i=>{x(i)},g=i=>{C(i.target.value)},P=()=>{const i=[...T];for(let c=0;c<p.length;c++)if(i.filter(u=>u.name===p[c]).length===0){const u=f.filter(h=>h.name===p[c]);u!=null&&u.length>0&&i.push(u[0])}j(i),y(i),F(),x([])},V=i=>{const c=T.filter(d=>d.name!==i.name);j(c),y(c)},z={selectedRowKeys:p,onChange:D},H=p.length>0;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách nhân viên"}),e.jsxs("div",{onClick:_,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn nhân viên"})]}),e.jsx("div",{className:"pt-6 mx-4",children:e.jsx(K,{columns:L,dataSource:T})}),e.jsxs(ee,{width:990,title:"Chọn nhân viên",open:b,onOk:O,onCancel:F,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:w,onChange:g,placeholder:"Tìm kiếm tên nhân viên",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:H?`Đã chọn ${p.length} nhân viên`:""}),e.jsx(ne,{type:"primary",onClick:P,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:z,columns:Ze,dataSource:f})})]})]})})}function tt(){const y=He(),[b]=xe.useForm(),[N,p]=n.useState("Open"),[x,f]=n.useState([]),[E,I]=n.useState([]),[S,w]=n.useState([]),[C,T]=n.useState({}),[j,L]=n.useState(!0),[R,_]=n.useState(!1),[O,F]=n.useState([]),[D,g]=n.useState(!1),P=async()=>{try{g(!0);let o=b.getFieldsValue(),k=V(o.campaign_start),B=V(o.campaign_end);if(k>=B){q.error("Thời gian bắt đầu phải nhỏ hơn Thời gian kết thúc"),g(!1);return}let $={},M=Object.getOwnPropertyNames(C);if(j&&($.min_product=C.min_product),R&&($.sequence_product=O),x.length===0){q.error("Vui lòng điền thông tin sản phẩm"),g(!1);return}if(E.length===0){q.error("Vui lòng chọn ít nhất một nhân viên."),g(!1);return}if(S.length===0){q.error("Vui lòng chọn ít nhất một khách hàng."),g(!1);return}if(o.campaign_name==null||o.campaign_name==""){q.error("Vui lòng nhập tên chiến dịch."),g(!1);return}let oe=x.map(G=>G.name),ae=E.map(G=>G.name),U=S.map(G=>G.name),ce="/api/resource/VGM_Campaign",re={campaign_name:o.campaign_name,campaign_description:o.campaign_description,start_date:k,end_date:B,campaign_status:N,categories:JSON.stringify(oe),employees:JSON.stringify(ae),retails:JSON.stringify(U),setting_score_audit:$},X=await Q.post(ce,re);X!=null&&X.data!=null?(q.success("Thêm mới thành công"),g(!1),y("/campaign")):(q.error("Thêm mới thất bại"),g(!1))}catch{q.error("Không thể thêm mới. Vui lòng kiểm tra lại thông tin thời gian, sản phẩm, nhân viên, khách hàng"),g(!1)}},V=o=>{const k=new Date(o),B=We(k).format("YYYY-MM-DD HH:mm:ss");return k.toISOString().slice(0,19).replace("T"," "),B},z=o=>{p(o)},H=o=>{f(o);const k={};o.forEach($=>{$.products.forEach(M=>{k.hasOwnProperty(M.key)?k[M.key]=Math.min(k[M.key],parseInt(M.product_num)):k[M.key]=parseInt(M.product_num)})}),T({min_product:k})},i=o=>{I(o)},c=o=>{w(o)},d=o=>{L(o)},u=o=>{_(o)},h=o=>{F(o)};return e.jsxs(e.Fragment,{children:[e.jsx(Be,{title:"Thêm mới chiến dịch",icon:e.jsx("p",{onClick:()=>y("/campaign"),className:"mr-2 cursor-pointer",children:e.jsx($e,{})}),buttons:[{label:"Thêm mới",type:"primary",size:"20px",className:"flex items-center",loading:D,action:P}]}),e.jsx("div",{className:"bg-white pt-4 rounded-xl border-[#DFE3E8] border-[0.2px] border-solid",children:e.jsx(xe,{layout:"vertical",form:b,children:e.jsx(Ge,{defaultActiveKey:"1",items:[{label:e.jsx("p",{className:"px-4 mb-0",children:" Thông tin chung"}),key:"1",children:e.jsx(Qe,{form:b,onCampaignStatusChange:z})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Sản phẩm"}),key:"2",children:e.jsx(Ue,{onChangeCategory:H,onChangeCheckExistProduct:d,onChangeCheckSequenceProduct:u,onChangeSequenceProducts:h})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Nhân viên bán hàng"}),key:"3",children:e.jsx(et,{onChangeEmployees:i})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Khách hàng"}),key:"4",children:e.jsx(Xe,{onChangeCustomer:c})}],indicatorSize:o=>o-18})})})]})}function st(){return e.jsxs(e.Fragment,{children:[e.jsx(Ye,{children:e.jsx("title",{children:" Campaign Create"})}),e.jsx(tt,{})]})}export{st as default};
