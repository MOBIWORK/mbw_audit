import{r as g,j as a,S as m,e as ie,f as He,u as Be,A as S,s as x,H as Ke,g as Ue,B as K,T as U,M as Fe,h as F,i as ze,D as Me,d as Je}from"./main-aLaftzUD.js";import{e as re,F as Le}from"./FileSaver.min-38jMAu0g.js";import{C as N,a as T}from"./CloseCircleOutlined-ERLvX-I9.js";import{V as Ve}from"./VerticalAlignBottomOutlined-0lcE4-GW.js";import{I as oe}from"./index-EO6Us9u7.js";const{RangePicker:Xe}=Me;function Ge(){const[v,z]=g.useState("all"),[b,de]=g.useState([]),[j,ce]=g.useState("all"),[I,he]=g.useState("all"),[R,ge]=g.useState("all"),[A,M]=g.useState(null),[J,We]=g.useState([{label:"Đạt",value:1},{label:"Không đạt",value:0}]),[C,E]=g.useState(!1),[L,V]=g.useState([{title:"STT",dataIndex:"stt",width:50},{title:"Khách hàng",dataIndex:"customer_name",width:100},{title:"Tên chiến dịch",dataIndex:"campaign_name",width:100},{title:"Nhân viên thực hiện",dataIndex:"employee_name",width:100},{title:"Số lượng danh mục",dataIndex:"quantity_cate",width:100},{title:"Số lượng sản phẩm AI đếm",children:[],width:300},{title:"Số lượng sản phẩm giám sát đếm",children:[],width:300},{title:"Ảnh gian hàng",dataIndex:"images",render:t=>{let e=[];if(t!==null)try{e=JSON.parse(t)}catch{}return a.jsx("a",{style:{cursor:e.length>0?"pointer":"default"},onClick:s=>{s.stopPropagation(),e.length>0&&$(t)},children:e.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:t=>{let e=[];if(t!==null)try{e=JSON.parse(t)}catch{}return a.jsx("a",{style:{cursor:e.length>0?"pointer":"default"},onClick:s=>{s.stopPropagation(),e.length>0&&$(t)},children:e.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Thời gian thực hiện",dataIndex:"images_time",render:t=>{const e=new Date(t),s=e.getDate(),n=e.getMonth()+1,l=e.getFullYear(),u=e.getHours(),o=e.getMinutes(),h=`${s.toString().padStart(2,"0")}/${n.toString().padStart(2,"0")}/${l} ${u.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`;return a.jsx("div",{children:h})},width:120},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:t=>a.jsxs(a.Fragment,{children:[t===1&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(N,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),t===0&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(T,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]}),width:120},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(t,e,s)=>a.jsx("div",{onClick:n=>{n.stopPropagation()},children:a.jsxs(m,{value:t,onChange:()=>ee(e,s,!0),bordered:A===s,onMouseEnter:()=>Q(s),onMouseLeave:Z,suffixIcon:A===s?a.jsx(ie,{}):null,children:[a.jsx(m.Option,{value:1,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(N,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),a.jsx(m.Option,{value:0,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(T,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})}),width:120}]),[y,D]=g.useState([]);He();const pe=Be(),[_,P]=g.useState([]),[me,ue]=g.useState([]),[xe,X]=g.useState([]),[fe,G]=g.useState(!1),[H,ye]=g.useState(0),[W,_e]=g.useState(0),[we,q]=g.useState(!1),Se=async()=>{if(C)if(y.length>0){const t=y.map(n=>({name:n.name,scoring_machine:n.scoring_machine}));let e={data_list:JSON.stringify(t)},s="/api/method/mbw_audit.api.api.updatelistreport_scorehuman_by_AI";try{const n=await S.post(s,e);n&&n.message.status==="success"?(k(),x.success("Cập nhật thành công")):x.error("Cập nhật thất bại")}catch{x.error("Cập nhật thất bại")}}else x.warning("Danh sách đang trống. Không thể cập nhật");else if(_.length>0){const t=_.map(n=>({name:n.name,scoring_machine:n.scoring_machine}));let e={data_list:JSON.stringify(t)},s="/api/method/mbw_audit.api.api.updatelistreport_scorehuman_by_AI";try{const n=await S.post(s,e);n&&n.message.status==="success"?(k(),x.success("Cập nhật thành công")):x.error("Cập nhật thất bại")}catch{x.error("Cập nhật thất bại")}}else x.warning("Danh sách đang trống. Không thể cập nhật")},je=async t=>{if(C)if(y.length>0){const e=y.map(l=>({name:l.name}));let s={data_list:JSON.stringify(e),val_score:t},n="/api/method/mbw_audit.api.api.update_list_report_by_val";try{const l=await S.post(n,s);l&&l.message.status==="success"?(k(),x.success("Cập nhật thành công")):x.error("Cập nhật thất bại")}catch{x.error("Cập nhật thất bại")}}else x.warning("Danh sách đang trống. Không thể cập nhật");else if(_.length>0){const e=_.map(l=>({name:l.name}));let s={data_list:JSON.stringify(e),val_score:t},n="/api/method/mbw_audit.api.api.update_list_report_by_val";try{const l=await S.post(n,s);l&&l.message.status==="success"?(k(),x.success("Cập nhật thành công")):x.error("Cập nhật thất bại")}catch{x.error("Cập nhật thất bại")}}else x.warning("Danh sách đang trống. Không thể cập nhật")},Y=(t,e)=>{localStorage.setItem("recordData",JSON.stringify(t)),C?localStorage.setItem("dataReports",JSON.stringify(y)):localStorage.setItem("dataReports",JSON.stringify(_)),pe("/report-view")};g.useEffect(()=>{be(),Ie()},[]);const Ce=[{title:"STT",dataIndex:"stt",fixed:"left",width:"5%"},{title:"Khách hàng",dataIndex:"customer_name",fixed:"left"},{title:"Tên chiến dịch",dataIndex:"campaign_name",fixed:"left"},{title:"Nhân viên thực hiện",dataIndex:"employee_name"},{title:"Số lượng danh mục",dataIndex:"quantity_cate"},{title:"Ảnh gian hàng",dataIndex:"images",render:t=>{let e=[];if(t!==null)try{e=JSON.parse(t)}catch{}return a.jsx("a",{style:{cursor:e.length>0?"pointer":"default"},onClick:s=>{s.stopPropagation(),e.length>0&&$(t)},children:e.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:t=>{let e=[];if(t!==null)try{e=JSON.parse(t)}catch{}return a.jsx("a",{style:{cursor:e.length>0?"pointer":"default"},onClick:s=>{s.stopPropagation(),e.length>0&&$(t)},children:e.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Thời gian thực hiện",dataIndex:"images_time",render:t=>{const e=new Date(t),s=e.getDate(),n=e.getMonth()+1,l=e.getFullYear(),u=e.getHours(),o=e.getMinutes(),h=`${s.toString().padStart(2,"0")}/${n.toString().padStart(2,"0")}/${l} ${u.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`;return a.jsx("div",{children:h})}},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:t=>a.jsxs(a.Fragment,{children:[t===1&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(N,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),t===0&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(T,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(t,e,s)=>a.jsx("div",{onClick:n=>{n.stopPropagation()},children:a.jsxs(m,{value:t,onChange:()=>ee(e,s,!1),bordered:A===s,onMouseEnter:()=>Q(s),onMouseLeave:Z,suffixIcon:A===s?a.jsx(ie,{}):null,children:[a.jsx(m.Option,{value:1,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(N,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),a.jsx(m.Option,{value:0,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(T,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})})}],ve=[{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Số lượng sản phẩm AI đếm",dataIndex:"sum_product"},{title:"Số lượng sản phẩm giám sát đếm",dataIndex:"sum_product_human"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:t=>a.jsxs(a.Fragment,{children:[t===1&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(N,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),t===0&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(T,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}],k=async()=>{const t=JSON.parse(localStorage.getItem("campaign_dashboard"));t&&(z(t.campaign_code),E(!0),localStorage.removeItem("campaign_dashboard"));let e="/api/method/mbw_audit.api.api.get_reports_by_filter";if(v!=null&&v!=""&&v!="all"&&(e=`${e}?campaign_code=${v}`),b!=null&&b.length==2){let n=Math.round(new Date(b[0]).getTime()/1e3),l=Math.round(new Date(b[1]).getTime()/1e3);e.includes("?")?e=`${e}&start_date=${n}&end_date=${l}`:e=`${e}?start_date=${n}&end_date=${l}`}j!=null&&j!=""&&j!="all"&&(e.includes("?")?e=`${e}&employee_id=${j}`:e=`${e}?employee_id=${j}`),I!=null&&I!="all"&&(e.includes("?")?e=`${e}&status_scoring_ai=${I}`:e=`${e}?status_scoring_ai=${I}`),R!=null&&R!="all"&&(e.includes("?")?e=`${e}&status_scoring_human=${R}`:e=`${e}?status_scoring_human=${R}`);let s=await S.get(e);if(s!=null&&s.message=="ok"&&s.result!=null&&s.result.data!=null){let n=s.result.data.map((l,u)=>{let o=(u+1).toString().padStart(2,"0"),h=JSON.parse(l.categories).length.toString().padStart(2,"0");return{...l,key:l.name,stt:o,quantity_cate:h}});if(!C)P(n);else{let l=[],u=[],o=new Set,h=[];for(let i=0;i<n.length;i++){const c=n[i].info_products_ai;for(let d=0;d<c.length;d++)h.filter(w=>w.product_name==c[d].product_name).length==0&&h.push(c[d]);c.forEach(d=>{o.add(d.product_name)})}if(h)for(let i=0;i<h.length;i++){const r=h[i].product_name,c={title:r,dataIndex:`${r}_ai`,key:`${r}_ai`,width:100},d={title:r,dataIndex:`${r}_human`,key:`${r}_human`,width:100};l.push(c),u.push(d)}const p=n.map(i=>{const r={...i};return o.forEach(c=>{const d=i.info_products_ai.find(w=>w.product_name===c),f=i.info_products_human.find(w=>w.product_name===c);d&&(r[`${c}_ai`]=d.sum),f&&(r[`${c}_human`]=f.sum)}),r});V(i=>(i[5].children=l,i[6].children=u,i)),D(p)}}else C?(V(n=>(n[5].children=[],n[6].children=[],n)),D([])):P([])},Q=t=>{M(t)},Z=()=>{M(!1)},ee=async(t,e,s=!1)=>{const n=t.scoring_human===1?0:1;let l={name:t.name,scoring_human:n};const o=await S.post("/api/method/mbw_audit.api.api.update_scorehuman_by_name",l);o!=null&&o.message=="ok"&&o.result!=null&&o.result.data=="success"?(x.success("Cập nhật thành công"),s?D(h=>{let p=[...h];return p[e].scoring_human=n,p}):P(h=>{let p=[...h];return p[e].scoring_human=n,p})):x.error("Cập nhật thất bại")},be=async()=>{try{const e=await S.get("/api/method/mbw_service_v2.api.ess.employee.get_list_employee");e&&e.result&&e.result.data&&ue(e.result.data)}catch{}},Ie=async()=>{const e=await S.get("/api/method/mbw_audit.api.api.get_all_campaigns");e!=null&&e.message=="ok"&&e.result!=null?X(e.result.data):X([])};g.useEffect(()=>{k()},[v,b,j,I,R]);const Re=()=>{C?ke(y,L):Ne(_)},ke=async(t,e,s)=>{const n=new re.Workbook,l=n.addWorksheet("Sheet1");let u=!1;for(let i=0;i<e.length;i++)if(e[i].children!=null&&e[i].children.length>0){u=!0;break}let o=1;for(let i=0;i<e.length;i++){let r=l.getRow(1);if(e[i].children!=null&&e[i].children.length>0){let c=o;r.getCell(o).style={font:{bold:!0,name:"Times New Roman",size:12}},r.getCell(o).value=e[i].title;for(let d=0;d<e[i].children.length;d++){let f=l.getRow(2);f.getCell(o).style={font:{bold:!0,name:"Times New Roman",size:12}},l.getColumn(o).width=e[i].children[d].width/5,f.getCell(o).value=e[i].children[d].title,o+=1}e[i].children.length>=2&&l.mergeCells(`${r.getCell(c)._address}:${r.getCell(o-1)._address}`)}else{if(l.getColumn(o).width=e[i].width/5,u){let c=l.getRow(2);l.mergeCells(`${r.getCell(o)._address}:${c.getCell(o)._address}`)}r.getCell(o).style={font:{bold:!0,name:"Times New Roman",size:12}},r.getCell(o).value=e[i].title,o+=1}}let h=2;u&&(h=3);for(let i=0;i<t.length;i++){let r=1,c=l.getRow(h);for(let d=0;d<e.length;d++)if(e[d].children!=null&&e[d].children.length>0)for(let f=0;f<e[d].children.length;f++)c.getCell(r).value=t[i][e[d].children[f].dataIndex],c.getCell(r).style={font:{bold:!1,name:"Times New Roman",size:12}},r+=1;else e[d].dataIndex=="scoring_human"||e[d].dataIndex=="scoring_machine"?c.getCell(r).value=te(t[i][e[d].dataIndex]):c.getCell(r).value=t[i][e[d].dataIndex],c.getCell(r).style={font:{bold:!1,name:"Times New Roman",size:12}},r+=1;h+=1}const p=await n.xlsx.writeBuffer();ae(p,"report")},te=t=>t===1?"Đạt":t===0?"Không đạt":"",Ne=async(t,e)=>{const s=new re.Workbook,n=s.addWorksheet("Sheet1");let l=[{title:"STT",width:10,key:"stt"},{title:"Khách hàng",width:20,key:"customer_name"},{title:"Tên chiến dịch",width:30,key:"campaign_name"},{title:"Nhân viên thực hiện",width:20,key:"employee_name"},{title:"Số lượng danh mục",width:20,key:"categories"},{title:"Ảnh gian hàng",width:30,key:"images"},{title:"Ảnh gian hàng AI",width:30,key:"images_ai"},{title:"Thời gian thực hiện",width:30,key:"images_time"},{title:"Điểm trưng bày AI chấm",width:20,key:"scoring_machine"},{title:"Điểm trưng bày giám sát chấm",width:20,key:"scoring_human"}],u=1;for(let p=0;p<l.length;p++){let i=n.getRow(1);n.getColumn(u).width=l[p].width,i.getCell(u).style={font:{bold:!0,name:"Times New Roman",size:12}},i.getCell(u).value=l[p].title,u+=1}let o=2;for(let p=0;p<t.length;p++){let i=1,r=n.getRow(o);for(let c=0;c<l.length;c++){if(l[c].key=="scoring_human"||l[c].key=="scoring_machine")r.getCell(i).value=te(t[p][l[c].key]);else if(l[c].key=="categories"){let d=t[p][l[c].key],f=0;if(d!=null&&d!=""){let w=JSON.parse(d);w!=null&&(f=w.length)}r.getCell(i).value=f}else r.getCell(i).value=t[p][l[c].key];r.getCell(i).style={font:{bold:!1,name:"Times New Roman",size:12}},i+=1}o+=1}const h=await s.xlsx.writeBuffer();ae(h,"report")},ae=(t,e)=>{let s="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8",n=".xlsx";const l=new Blob([t],{type:s});Le.saveAs(l,e+"_export_"+new Date().getTime()+n)},Te=t=>{z(t),t=="all"?E(!1):E(!0)},[Ae,ne]=g.useState([]),[Oe,le]=g.useState(!1),$e=t=>{le(!1),ne([])},O=(t,e)=>(e?.children??"").toLowerCase().includes(t.toLowerCase()),$=t=>{const e=JSON.parse(t);ne(e),le(!0)},Ee=()=>{G(!0)},B=()=>{G(!1)},se=async()=>{q(!0),H==0?await Se():await je(W),q(!1),B()},De=t=>{ye(t.target.value)},Pe=t=>{_e(t)};return a.jsxs(a.Fragment,{children:[a.jsx(Ke,{title:"Báo cáo",buttons:[{label:"Xuất dữ liệu",type:"primary",icon:a.jsx(Ve,{className:"text-xl"}),size:"20px",className:"flex items-center",action:Re}]}),a.jsxs("div",{className:"bg-white rounded-xl",children:[a.jsx("div",{className:"flex p-4",style:{alignItems:"flex-end"},children:a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[a.jsxs("div",{style:{display:"flex",alignItems:"flex-end",flexWrap:"wrap"},children:[a.jsxs("div",{className:"mt-2",style:{display:"flex",flexDirection:"column",paddingRight:"15px"},children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Chiến dịch:"}),a.jsxs(m,{showSearch:!0,className:"w-[150px] h-[36px]",value:v,onChange:t=>Te(t),defaultValue:"all",filterOption:O,optionFilterProp:"children",children:[a.jsx(m.Option,{value:"all",children:"Tất cả"}),xe.map(t=>a.jsx(m.Option,{value:t.name,children:t.campaign_name},t.name))]})]}),a.jsx(Ue,{className:"w-[250px] border-none mr-4 mt-2",label:"Thời gian thực hiện",children:a.jsx(Xe,{value:b,onChange:t=>de(t)})}),a.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4 mt-2",children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Nhân viên:"}),a.jsxs(m,{showSearch:!0,className:"w-[150px] h-[36px]",value:j,onChange:t=>ce(t),defaultValue:"all",filterOption:O,optionFilterProp:"children",children:[a.jsx(m.Option,{value:"all",children:"Tất cả"}),me.map(t=>a.jsx(m.Option,{value:t.name,children:t.employee_name},t.name))]})]}),a.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4 mt-2",children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm AI chấm:"}),a.jsxs(m,{showSearch:!0,className:"w-[150px] h-[36px]",value:I,onChange:t=>he(t),defaultValue:"all",filterOption:O,optionFilterProp:"children",children:[a.jsx(m.Option,{value:"all",children:"Tất cả"}),J.map(t=>a.jsx(m.Option,{value:t.value,children:t.label},t.value))]})]}),a.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4 mt-2",children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm giám sát chấm:"}),a.jsxs(m,{className:"w-[150px] h-[36px]",value:R,onChange:t=>ge(t),defaultValue:"all",filterOption:O,optionFilterProp:"children",showSearch:!0,children:[a.jsx(m.Option,{value:"all",children:"Tất cả"}),J.map(t=>a.jsx(m.Option,{value:t.value,children:t.label},t.value))]})]})]}),a.jsx("div",{style:{display:"flex",alignItems:"flex-end"},children:a.jsx(K,{type:"primary",onClick:Ee,children:"Cập nhật điểm giám sát chấm"})})]})}),a.jsx("div",{children:C?a.jsx(U,{bordered:!0,columns:L,dataSource:y,pagination:y.length>5,scroll:{y:540,x:2e3},onRow:(t,e)=>({onClick:()=>Y(t)})}):a.jsx(U,{bordered:!0,columns:Ce,dataSource:_,scroll:{y:540,x:1300},pagination:_.length>5,onRow:(t,e)=>({onClick:()=>Y(t)}),expandable:{expandedRowRender:(t,e)=>a.jsx("div",{style:{margin:5},children:a.jsx(U,{columns:ve,dataSource:t.detail_skus,pagination:!1})})}})})]}),a.jsx(oe.PreviewGroup,{preview:{visible:Oe,onVisibleChange:$e},children:Ae.map((t,e)=>a.jsx(oe,{style:{display:"none"},width:50,src:t},e))}),a.jsxs(Fe,{title:"Cập nhật điểm trưng bày giám sát chấm",open:fe,width:600,onOk:se,onCancel:B,footer:[a.jsx(K,{onClick:B,children:"Hủy"},"back"),a.jsx(K,{type:"primary",onClick:se,loading:we,children:"Lưu lại"},"submit")],children:[a.jsx("p",{className:"text-[#637381] font-normal text-sm",children:"Dữ liệu chấm điểm trưng bày giám sát chấm sẽ được cập nhật dựa theo một trong các tiêu chí"}),a.jsx(F.Group,{onChange:De,value:H,children:a.jsxs(ze,{direction:"vertical",children:[a.jsx(F,{value:0,children:"Điểm trưng bày giám sát chấm được cập nhập dựa theo AI chấm"}),a.jsx(F,{value:1,children:"Điểm trưng bày giám sát chấm được cập nhập theo giá trị được chọn"})]})}),H===1&&a.jsx(m,{defaultValue:W,style:{width:540,marginTop:10,marginBottom:10},onChange:Pe,options:[{value:0,label:"Không đạt"},{value:1,label:"Đạt"}]})]})]})}function tt(){return a.jsxs(a.Fragment,{children:[a.jsx(Je,{children:a.jsx("title",{children:"BÁO CÁO"})}),a.jsx(Ge,{})]})}export{tt as default};
