import{r as c,j as t,e as fe,u as ye,A as k,H as _e,S as g,f as je,T as D,D as Ce,d as ve}from"./main-kqMsOJ0h.js";import{V as Se,e as G,F as Ie}from"./FileSaver.min-8HOEA7SQ.js";import{C as I,a as w,I as U}from"./CloseCircleOutlined-QmBdCZ3r.js";const{RangePicker:we}=Ce;function be(){const[y,B]=c.useState("all"),[_,Y]=c.useState([]),[u,Q]=c.useState("all"),[j,Z]=c.useState("all"),[C,ee]=c.useState("all");c.useState(!1);const[O,Ae]=c.useState([{label:"Đạt",value:1},{label:"Không đạt",value:0}]),[b,T]=c.useState(!1),[z,P]=c.useState([{title:"STT",dataIndex:"stt",fixed:"left",width:100},{title:"Khách hàng",dataIndex:"customer_name",fixed:"left"},{title:"Tên chiến dịch",dataIndex:"campaign_name",fixed:"left"},{title:"Nhân viên thực hiện",dataIndex:"employee_name"},{title:"Số lượng danh mục",dataIndex:"quantity_cate"},{title:"Số lượng sản phẩm AI đếm",children:[]},{title:"Số lượng sản phẩm giám sát đếm",children:[]},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>t.jsx("a",{onClick:l=>{l.stopPropagation(),A(e)},children:"Xem hình ảnh"})},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>t.jsx("a",{onClick:l=>{l.stopPropagation(),A(e)},children:"Xem hình ảnh"})},{title:"Thời gian thực hiện",dataIndex:"images_time"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}]),[F,H]=c.useState([]),{search:te}=fe();new URLSearchParams(te).get("campaign");const le=ye(),[N,K]=c.useState([]),[ae,ne]=c.useState([]),[ie,X]=c.useState([]),J=e=>{localStorage.setItem("recordData",JSON.stringify(e)),localStorage.setItem("dataReports",JSON.stringify(N)),le("/report-view")};c.useEffect(()=>{oe(),de(),V()},[]);const se=[{title:"STT",dataIndex:"stt",fixed:"left",width:"5%"},{title:"Khách hàng",dataIndex:"customer_name",fixed:"left"},{title:"Tên chiến dịch",dataIndex:"campaign_name",fixed:"left"},{title:"Nhân viên thực hiện",dataIndex:"employee_name"},{title:"Số lượng danh mục",dataIndex:"quantity_cate"},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>t.jsx("a",{onClick:l=>{l.stopPropagation(),A(e)},children:"Xem hình ảnh"})},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>t.jsx("a",{onClick:l=>{l.stopPropagation(),A(e)},children:"Xem hình ảnh"})},{title:"Thời gian thực hiện",dataIndex:"images_time"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}],re=[{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Số lượng sản phẩm AI đếm",dataIndex:"sum_product"},{title:"Số lượng sản phẩm giám sát đếm",dataIndex:"sum_product_human"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>t.jsxs(t.Fragment,{children:[e===1&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&t.jsxs("span",{style:{display:"flex"},children:[t.jsx(w,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",t.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}],V=async()=>{const e=JSON.parse(localStorage.getItem("campaign_dashboard"));e&&(B(e.campaign_code),T(!0),localStorage.removeItem("campaign_dashboard"));let l="/api/method/mbw_audit.api.api.get_reports_by_filter";if(y!=null&&y!=""&&y!="all"&&(l=`${l}?campaign_code=${y}`),_!=null&&_.length==2){let n=Math.round(new Date(_[0]).getTime()/1e3),s=Math.round(new Date(_[1]).getTime()/1e3);l.includes("?")?l=`${l}&start_date=${n}&end_date=${s}`:l=`${l}?start_date=${n}&end_date=${s}`}u!=null&&u!=""&&u!="all"&&(l.includes("?")?l=`${l}&employee_id=${u}`:l=`${l}?employee_id=${u}`),j!=null&&j!="all"&&(l.includes("?")?l=`${l}&status_scoring_ai=${j}`:l=`${l}?status_scoring_ai=${j}`,console.log(l)),C!=null&&C!="all"&&(l.includes("?")?l=`${l}&status_scoring_human=${C}`:l=`${l}?status_scoring_human=${C}`);let m=await k.get(l);if(m!=null&&m.message=="ok"&&m.result!=null&&m.result.data!=null){let n=m.result.data.map((s,r)=>{let o=(r+1).toString().padStart(2,"0"),i=JSON.parse(s.categories).length.toString().padStart(2,"0");return{...s,key:s.name,stt:o,quantity_cate:i}});if(!b)K(n);else{let s=!1,r=[],o=[];for(let i=0;i<n.length;i++){for(let a=0;a<n[i].info_products_ai.length;a++){if(!s){let f={title:n[i].info_products_ai[a].product_name,dataIndex:`${n[i].info_products_ai[a].product_name}_ai`,key:`${n[i].info_products_ai[a].product_name}_ai`,width:100},h={title:n[i].info_products_ai[a].product_name,dataIndex:`${n[i].info_products_ai[a].product_name}_human`,key:`${n[i].info_products_ai[a].product_name}_human`,width:100};r.push(f),o.push(h)}n[i][`${n[i].info_products_ai[a].product_name}_ai`]=n[i].info_products_ai[a].sum,n[i][`${n[i].info_products_human[a].product_name}_human`]=n[i].info_products_human[a].sum}r.length>0&&(s=!0)}P(i=>(i[5].children=r,i[6].children=o,i)),H(n)}}else b?(P(n=>(n[5].children=[],n[6].children=[],n)),H([])):K([])},oe=async()=>{try{const l=await k.get("/api/method/mbw_service_v2.api.ess.employee.get_list_employee");l&&l.result&&l.result.data&&ne(l.result.data)}catch(e){console.error("Error fetching employee data:",e)}},de=async()=>{const l=await k.get("/api/method/mbw_audit.api.api.get_all_campaigns");l!=null&&l.message=="ok"&&l.result!=null?X(l.result.data):X([])};c.useEffect(()=>{V()},[y,_,u,j,C]);const ce=()=>{b?me(F,z):he(N,"Báo cáo chấm điểm trưng bày")},$=(e,l=!1)=>{const m={font:{bold:!0,name:"Times New Roman",size:12},alignment:{vertical:"middle",horizontal:"center"}};l&&(m.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}),e.style=m},me=async(e,l,m)=>{console.log(e),console.log(l);const n=new G.Workbook,s=n.addWorksheet("Sheet1");let r=1;l.forEach((a,f)=>{const h=r;r===1?s.getColumn(r).width=10:s.getColumn(r).width=a.width||20;const x=s.getCell(1,r);if(x.value=a.title,$(x,!0),a.children&&a.children.length>0){const d=a.children.length;x.isMerged||s.mergeCells(1,r,1,r+d-1),a.children.forEach((S,E)=>{const q=h+E,v=s.getCell(2,q);v.value=S.title,$(v)}),r+=d}else r++});const o=3;e.forEach((a,f)=>{r=1,l.forEach((h,x)=>{const d=h.dataIndex;let p=a[d];if(h.children&&h.children.length>0)return;if(d.endsWith("_ai")||d.endsWith("_human")){const[E,q]=h.title.split(" "),v=a[E.toLowerCase()];v&&Array.isArray(v)&&(p=v.filter(R=>R.product_name===E).map(R=>`${R.product_name}: ${R.sum}`).join(`
`))}const S=s.getCell(o+f,r);S.value=p,$(S,!1),r++})});const i=await n.xlsx.writeBuffer();W(i,"report")},he=async(e,l)=>{const m=new G.Workbook,n=m.addWorksheet("Sheet1");n.properties.defaultColWidth=20,n.getColumn("A").width=30,n.mergeCells("A2:J2"),n.getCell("A2").value=l,n.getCell("A2").style={font:{bold:!0,name:"Times New Roman",size:12}},n.getCell("A2").alignment={vertical:"middle",horizontal:"center"};let s=n.getRow(4),r=n.getRow(5),o=[{title:"Khách hàng",field:"customer_name"},{title:"Tên chiến dịch",field:"campaign_name"},{title:"Nhân viên thực hiện",field:"employee_name"},{title:"Số lượng danh mục",field:"categories"},{title:"Ảnh gian hàng",field:"images"},{title:"Ảnh gian hàng AI",field:"images_ai"},{title:"Thời gian thực hiện",field:"images_time"},{title:"Điểm trưng bày AI chấm",field:"scoring_machine"},{title:"Điểm trưng bày giám sát chấm",field:"scoring_human"}];for(let a=0;a<o.length;a++){let f=s.getCell(a+1),h=r.getCell(a+1);n.mergeCells(`${f._address}:${h._address}`),s.getCell(a+1).style={font:{bold:!0,name:"Times New Roman",size:12,italic:!0}},s.getCell(a+1).alignment={vertical:"middle",horizontal:"center"},s.getCell(a+1).value=o[a].title}for(let a=0;a<e.length;a++){let h=n.getRow(a+6),x=1;for(let d=0;d<o.length;d++){h.getCell(x).style={font:{name:"Times New Roman",size:12,italic:!0}};let p="";o[d].field=="categories"?e[a][o[d].field]!=null&&e[a][o[d].field]!=""&&(p=JSON.parse(e[a][o[d].field]).length):o[d].field=="scoring_machine"||o[d].field=="scoring_human"?e[a][o[d].field]==0?p="Không đạt":p="Đạt":p=e[a][o[d].field],h.getCell(x).value=p,x+=1}}const i=await m.xlsx.writeBuffer();W(i,"report")},W=(e,l)=>{let m="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8",n=".xlsx";const s=new Blob([e],{type:m});Ie.saveAs(s,l+"_export_"+new Date().getTime()+n)},ge=e=>{B(e),e=="all"?T(!1):T(!0)},[pe,M]=c.useState([]),[xe,L]=c.useState(!1),ue=e=>{L(!1),M([])},A=e=>{const l=JSON.parse(e);M(l),L(!0)};return t.jsxs(t.Fragment,{children:[t.jsx(_e,{title:"Báo cáo",buttons:[{label:"Xuất dữ liệu",type:"primary",icon:t.jsx(Se,{className:"text-xl"}),size:"20px",className:"flex items-center",action:ce}]}),t.jsxs("div",{className:"bg-white rounded-xl",children:[t.jsxs("div",{className:"flex p-4",style:{alignItems:"flex-end"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",paddingRight:"15px"},children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Chiến dịch:"}),t.jsxs(g,{className:"w-[150px] h-[36px]",value:y,onChange:e=>ge(e),defaultValue:"all",children:[t.jsx(g.Option,{value:"all",children:"Tất cả"}),ie.map(e=>t.jsx(g.Option,{value:e.name,children:e.campaign_name},e.name))]})]}),t.jsx(je,{className:"w-[250px] border-none mr-4",label:"Thời gian thực hiện",children:t.jsx(we,{value:_,onChange:e=>Y(e)})}),t.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Nhân viên:"}),t.jsxs(g,{className:"w-[150px] h-[36px]",value:u,onChange:e=>Q(e),defaultValue:"all",children:[t.jsx(g.Option,{value:"all",children:"Tất cả"}),ae.map(e=>t.jsx(g.Option,{value:e.name,children:e.employee_name},e.name))]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm AI chấm:"}),t.jsxs(g,{className:"w-[150px] h-[36px]",value:j,onChange:e=>Z(e),defaultValue:"all",children:[t.jsx(g.Option,{value:"all",children:"Tất cả"}),O.map(e=>t.jsx(g.Option,{value:e.value,children:e.label},e.value))]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[t.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm giám sát chấm:"}),t.jsxs(g,{className:"w-[150px] h-[36px]",value:C,onChange:e=>ee(e),defaultValue:"all",children:[t.jsx(g.Option,{value:"all",children:"Tất cả"}),O.map(e=>t.jsx(g.Option,{value:e.value,children:e.label},e.value))]})]})]}),t.jsx("div",{children:b?t.jsx(D,{bordered:!0,columns:z,dataSource:F,scroll:{y:540,x:2e3},onRow:(e,l)=>({onClick:()=>J(e)}),rowHoverBg:"#f0f0f0"}):t.jsx(D,{columns:se,dataSource:N,scroll:{y:540,x:1300},onRow:(e,l)=>({onClick:()=>J(e)}),rowHoverBg:"#f0f0f0",expandable:{expandedRowRender:(e,l)=>t.jsx("div",{style:{margin:5},children:t.jsx(D,{columns:re,dataSource:e.detail_skus,pagination:!1})})}})})]}),t.jsx(U.PreviewGroup,{preview:{visible:xe,onVisibleChange:ue},children:pe.map((e,l)=>t.jsx(U,{style:{display:"none"},width:50,src:e},l))})]})}function ke(){return t.jsxs(t.Fragment,{children:[t.jsx(ve,{children:t.jsx("title",{children:"BÁO CÁO"})}),t.jsx(be,{})]})}export{ke as default};
