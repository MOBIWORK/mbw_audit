import{r as c,j as a,S as h,e as ee,f as Ie,u as be,A as D,s as te,H as Ee,g as $e,T as z,D as Ae,d as Re}from"./main--vhBDeH1.js";import{V as Te,e as ae,F as Ne}from"./FileSaver.min-CEPhwJ4r.js";import{C as I,a as b}from"./CloseCircleOutlined-rJYYr12s.js";import{I as ne}from"./index-VDcUvrHr.js";const{RangePicker:Oe}=Ae;function De(){const[S,F]=c.useState("all"),[j,le]=c.useState([]),[y,ie]=c.useState("all"),[v,se]=c.useState("all"),[C,re]=c.useState("all"),[E,H]=c.useState(null);c.useState(!1);const[K,ke]=c.useState([{label:"Đạt",value:1},{label:"Không đạt",value:0}]),[$,k]=c.useState(!1),[J,L]=c.useState([{title:"STT",dataIndex:"stt",width:50},{title:"Khách hàng",dataIndex:"customer_name",width:100},{title:"Tên chiến dịch",dataIndex:"campaign_name",width:100},{title:"Nhân viên thực hiện",dataIndex:"employee_name",width:100},{title:"Số lượng danh mục",dataIndex:"quantity_cate",width:100},{title:"Số lượng sản phẩm AI đếm",children:[],width:300},{title:"Số lượng sản phẩm giám sát đếm",children:[],width:300},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(n){console.error("Error parsing item:",n)}return a.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:n=>{n.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(n){console.error("Error parsing item:",n)}return a.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:n=>{n.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const t=new Date(e),n=t.getDate(),i=t.getMonth()+1,s=t.getFullYear(),r=t.getHours(),p=t.getMinutes(),l=`${n.toString().padStart(2,"0")}/${i.toString().padStart(2,"0")}/${s} ${r.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`;return a.jsx("div",{children:l})},width:120},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>a.jsxs(a.Fragment,{children:[e===1&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(b,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]}),width:120},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,t,n)=>a.jsx("div",{onClick:i=>{i.stopPropagation()},children:a.jsxs(h,{defaultValue:e,onChange:()=>q(t,n),bordered:E===n,onMouseEnter:()=>U(n),onMouseLeave:Y,suffixIcon:E===n?a.jsx(ee,{}):null,children:[a.jsx(h.Option,{value:1,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),a.jsx(h.Option,{value:0,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(b,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})}),width:120}]),[P,V]=c.useState([]),{search:oe}=Ie();new URLSearchParams(oe).get("campaign");const de=be(),[A,B]=c.useState([]),[ce,he]=c.useState([]),[ge,X]=c.useState([]),W=(e,t)=>{localStorage.setItem("recordData",JSON.stringify(e)),localStorage.setItem("dataReports",JSON.stringify(A)),de("/report-view")};c.useEffect(()=>{xe(),fe()},[]);const me=[{title:"STT",dataIndex:"stt",fixed:"left",width:"5%"},{title:"Khách hàng",dataIndex:"customer_name",fixed:"left"},{title:"Tên chiến dịch",dataIndex:"campaign_name",fixed:"left"},{title:"Nhân viên thực hiện",dataIndex:"employee_name"},{title:"Số lượng danh mục",dataIndex:"quantity_cate"},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(n){console.error("Error parsing item:",n)}return a.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:n=>{n.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(n){console.error("Error parsing item:",n)}return a.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:n=>{n.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const t=new Date(e),n=t.getDate(),i=t.getMonth()+1,s=t.getFullYear(),r=t.getHours(),p=t.getMinutes(),l=`${n.toString().padStart(2,"0")}/${i.toString().padStart(2,"0")}/${s} ${r.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`;return a.jsx("div",{children:l})}},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>a.jsxs(a.Fragment,{children:[e===1&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(b,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,t,n)=>a.jsx("div",{onClick:i=>{i.stopPropagation()},children:a.jsxs(h,{defaultValue:e,onChange:()=>q(t,n),bordered:E===n,onMouseEnter:()=>U(n),onMouseLeave:Y,suffixIcon:E===n?a.jsx(ee,{}):null,children:[a.jsx(h.Option,{value:1,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),a.jsx(h.Option,{value:0,children:a.jsxs("span",{style:{display:"flex"},children:[a.jsx(b,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})})}],pe=[{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Số lượng sản phẩm AI đếm",dataIndex:"sum_product"},{title:"Số lượng sản phẩm giám sát đếm",dataIndex:"sum_product_human"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>a.jsxs(a.Fragment,{children:[e===1&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(I,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&a.jsxs("span",{style:{display:"flex"},children:[a.jsx(b,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",a.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}],ue=async()=>{const e=JSON.parse(localStorage.getItem("campaign_dashboard"));e&&(F(e.campaign_code),k(!0),localStorage.removeItem("campaign_dashboard"));let t="/api/method/mbw_audit.api.api.get_reports_by_filter";if(S!=null&&S!=""&&S!="all"&&(t=`${t}?campaign_code=${S}`),j!=null&&j.length==2){let i=Math.round(new Date(j[0]).getTime()/1e3),s=Math.round(new Date(j[1]).getTime()/1e3);t.includes("?")?t=`${t}&start_date=${i}&end_date=${s}`:t=`${t}?start_date=${i}&end_date=${s}`}y!=null&&y!=""&&y!="all"&&(t.includes("?")?t=`${t}&employee_id=${y}`:t=`${t}?employee_id=${y}`),v!=null&&v!="all"&&(t.includes("?")?t=`${t}&status_scoring_ai=${v}`:t=`${t}?status_scoring_ai=${v}`,console.log(t)),C!=null&&C!="all"&&(t.includes("?")?t=`${t}&status_scoring_human=${C}`:t=`${t}?status_scoring_human=${C}`);let n=await D.get(t);if(n!=null&&n.message=="ok"&&n.result!=null&&n.result.data!=null){let i=n.result.data.map((s,r)=>{let p=(r+1).toString().padStart(2,"0"),l=JSON.parse(s.categories).length.toString().padStart(2,"0");return{...s,key:s.name,stt:p,quantity_cate:l}});if(!$)B(i);else{let s=!1,r=[],p=[];for(let l=0;l<i.length;l++){for(let d=0;d<i[l].info_products_ai.length;d++){if(!s){let o={title:i[l].info_products_ai[d].product_name,dataIndex:`${i[l].info_products_ai[d].product_name}_ai`,key:`${i[l].info_products_ai[d].product_name}_ai`,width:100},g={title:i[l].info_products_ai[d].product_name,dataIndex:`${i[l].info_products_ai[d].product_name}_human`,key:`${i[l].info_products_ai[d].product_name}_human`,width:100};r.push(o),p.push(g)}i[l][`${i[l].info_products_ai[d].product_name}_ai`]=i[l].info_products_ai[d].sum,i[l][`${i[l].info_products_human[d].product_name}_human`]=i[l].info_products_human[d].sum}r.length>0&&(s=!0)}L(l=>(l[5].children=r,l[6].children=p,l)),V(i)}}else $?(L(i=>(i[5].children=[],i[6].children=[],i)),V([])):B([])},U=e=>{H(e)},Y=()=>{H(!1)},q=async(e,t)=>{const n=e.scoring_human===1?0:1;let i={name:e.name,scoring_human:n};const r=await D.post("/api/method/mbw_audit.api.api.update_scorehuman_by_name",i);r!=null&&r.message=="ok"&&r.result!=null&&r.result.data=="success"?(te.success("Cập nhật thành công"),B(p=>{const l=[...p];return l[t].scoring_human=n,l})):te.error("Cập nhật thất bại")},xe=async()=>{try{const t=await D.get("/api/method/mbw_service_v2.api.ess.employee.get_list_employee");t&&t.result&&t.result.data&&he(t.result.data)}catch(e){console.error("Error fetching employee data:",e)}},fe=async()=>{const t=await D.get("/api/method/mbw_audit.api.api.get_all_campaigns");t!=null&&t.message=="ok"&&t.result!=null?X(t.result.data):X([])};c.useEffect(()=>{ue()},[S,j,y,v,C]);const ye=()=>{$?_e(P,J):Se(A,"Báo cáo chấm điểm trưng bày")},M=(e,t=!1)=>{const n={font:{bold:!0,name:"Times New Roman",size:12},alignment:{vertical:"middle",horizontal:"center"}};t&&(n.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}),e.style=n},_e=async(e,t,n)=>{console.log(e),console.log(t);const i=new ae.Workbook,s=i.addWorksheet("Sheet1");let r=1;t.forEach((d,o)=>{const g=r;r===1?s.getColumn(r).width=10:s.getColumn(r).width=d.width||20;const f=s.getCell(1,r);if(f.value=d.title,M(f,!0),d.children&&d.children.length>0){const u=d.children.length;f.isMerged||s.mergeCells(1,r,1,r+u-1),d.children.forEach((x,_)=>{const N=g+_,w=s.getCell(2,N);w.value=x.title,M(w)}),r+=u}else r++});const p=3;e.forEach((d,o)=>{r=1,t.forEach((g,f)=>{const u=g.dataIndex;let m=d[u];if(g.children&&g.children.length>0)return;if(u.endsWith("_ai")||u.endsWith("_human")){const[_,N]=g.title.split(" "),w=d[_.toLowerCase()];w&&Array.isArray(w)&&(m=w.filter(O=>O.product_name===_).map(O=>`${O.product_name}: ${O.sum}`).join(`
`))}const x=s.getCell(p+o,r);x.value=m,M(x,!1),r++})});const l=await i.xlsx.writeBuffer();G(l,"report")},Se=async(e,t)=>{let n=e.map(o=>{const g=new Date(o.images_time),f=g.getDate(),u=g.getMonth()+1,m=g.getFullYear(),x=g.getHours(),_=g.getMinutes(),N=`${f.toString().padStart(2,"0")}/${u.toString().padStart(2,"0")}/${m} ${x.toString().padStart(2,"0")}:${_.toString().padStart(2,"0")}`;return o.images_time=N,o});const i=new ae.Workbook,s=i.addWorksheet("Sheet1");s.properties.defaultColWidth=20,s.getColumn("A").width=30,s.mergeCells("A2:J2"),s.getCell("A2").value=t,s.getCell("A2").style={font:{bold:!0,name:"Times New Roman",size:12}},s.getCell("A2").alignment={vertical:"middle",horizontal:"center"};let r=s.getRow(4),p=s.getRow(5),l=[{title:"Khách hàng",field:"customer_name"},{title:"Tên chiến dịch",field:"campaign_name"},{title:"Nhân viên thực hiện",field:"employee_name"},{title:"Số lượng danh mục",field:"categories"},{title:"Ảnh gian hàng",field:"images"},{title:"Ảnh gian hàng AI",field:"images_ai"},{title:"Thời gian thực hiện",field:"images_time"},{title:"Điểm trưng bày AI chấm",field:"scoring_machine"},{title:"Điểm trưng bày giám sát chấm",field:"scoring_human"}];for(let o=0;o<l.length;o++){let g=r.getCell(o+1),f=p.getCell(o+1);s.mergeCells(`${g._address}:${f._address}`),r.getCell(o+1).style={font:{bold:!0,name:"Times New Roman",size:12,italic:!0}},r.getCell(o+1).alignment={vertical:"middle",horizontal:"center"},r.getCell(o+1).value=l[o].title}for(let o=0;o<n.length;o++){let f=s.getRow(o+6),u=1;for(let m=0;m<l.length;m++){f.getCell(u).style={font:{name:"Times New Roman",size:12,italic:!0}};let x="";l[m].field=="categories"?n[o][l[m].field]!=null&&n[o][l[m].field]!=""&&(x=JSON.parse(n[o][l[m].field]).length):l[m].field=="scoring_machine"||l[m].field=="scoring_human"?n[o][l[m].field]==0?x="Không đạt":x="Đạt":x=n[o][l[m].field],f.getCell(u).value=x,u+=1}}const d=await i.xlsx.writeBuffer();G(d,"report")},G=(e,t)=>{let n="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8",i=".xlsx";const s=new Blob([e],{type:n});Ne.saveAs(s,t+"_export_"+new Date().getTime()+i)},je=e=>{F(e),e=="all"?k(!1):k(!0)},[ve,Q]=c.useState([]),[Ce,Z]=c.useState(!1),we=e=>{Z(!1),Q([])},R=(e,t)=>(t?.children??"").toLowerCase().includes(e.toLowerCase()),T=e=>{const t=JSON.parse(e);Q(t),Z(!0)};return a.jsxs(a.Fragment,{children:[a.jsx(Ee,{title:"Báo cáo",buttons:[{label:"Xuất dữ liệu",type:"primary",icon:a.jsx(Te,{className:"text-xl"}),size:"20px",className:"flex items-center",action:ye}]}),a.jsxs("div",{className:"bg-white rounded-xl",children:[a.jsxs("div",{className:"flex p-4",style:{alignItems:"flex-end"},children:[a.jsxs("div",{style:{display:"flex",flexDirection:"column",paddingRight:"15px"},children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Chiến dịch:"}),a.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:S,onChange:e=>je(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[a.jsx(h.Option,{value:"all",children:"Tất cả"}),ge.map(e=>a.jsx(h.Option,{value:e.name,children:e.campaign_name},e.name))]})]}),a.jsx($e,{className:"w-[250px] border-none mr-4",label:"Thời gian thực hiện",children:a.jsx(Oe,{value:j,onChange:e=>le(e)})}),a.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Nhân viên:"}),a.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:y,onChange:e=>ie(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[a.jsx(h.Option,{value:"all",children:"Tất cả"}),ce.map(e=>a.jsx(h.Option,{value:e.name,children:e.employee_name},e.name))]})]}),a.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm AI chấm:"}),a.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:v,onChange:e=>se(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[a.jsx(h.Option,{value:"all",children:"Tất cả"}),K.map(e=>a.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]}),a.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[a.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm giám sát chấm:"}),a.jsxs(h,{className:"w-[150px] h-[36px]",value:C,onChange:e=>re(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",showSearch:!0,children:[a.jsx(h.Option,{value:"all",children:"Tất cả"}),K.map(e=>a.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]})]}),a.jsx("div",{children:$?a.jsx(z,{bordered:!0,columns:J,dataSource:P,pagination:P.length>5,scroll:{y:540,x:2e3},onRow:(e,t)=>({onClick:()=>W(e)}),rowHoverBg:"#f0f0f0"}):a.jsx(z,{bordered:!0,columns:me,dataSource:A,scroll:{y:540,x:1300},pagination:A.length>5,onRow:(e,t)=>({onClick:()=>W(e)}),rowHoverBg:"#f0f0f0",expandable:{expandedRowRender:(e,t)=>a.jsx("div",{style:{margin:5},children:a.jsx(z,{columns:pe,dataSource:e.detail_skus,pagination:!1})})}})})]}),a.jsx(ne.PreviewGroup,{preview:{visible:Ce,onVisibleChange:we},children:ve.map((e,t)=>a.jsx(ne,{style:{display:"none"},width:50,src:e},t))})]})}function Ke(){return a.jsxs(a.Fragment,{children:[a.jsx(Re,{children:a.jsx("title",{children:"BÁO CÁO"})}),a.jsx(De,{})]})}export{Ke as default};
