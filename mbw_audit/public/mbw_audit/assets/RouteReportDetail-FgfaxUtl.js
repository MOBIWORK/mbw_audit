import{r as d,j as n,S as h,e as te,f as $e,u as Ne,A as C,s as p,H as ke,g as Oe,h as Te,R as De,i as Pe,B as Be,E as Ke,T as z,D as Me,d as ze}from"./main-an_lgPKj.js";import{V as He,e as ne,F as Fe}from"./FileSaver.min-1R5OmSmw.js";import{C as $,a as N}from"./CloseCircleOutlined-hlnoPwj_.js";import{I as ae}from"./index-G-bdhyWy.js";const{RangePicker:Je}=Me;function Le(){const[b,H]=d.useState("all"),[I,le]=d.useState([]),[w,se]=d.useState("all"),[R,ie]=d.useState("all"),[E,re]=d.useState("all"),[k,F]=d.useState(null);d.useState(!1);const[J,Ue]=d.useState([{label:"Đạt",value:1},{label:"Không đạt",value:0}]),[S,D]=d.useState(!1),[L,U]=d.useState([{title:"STT",dataIndex:"stt",width:50},{title:"Khách hàng",dataIndex:"customer_name",width:100},{title:"Tên chiến dịch",dataIndex:"campaign_name",width:100},{title:"Nhân viên thực hiện",dataIndex:"employee_name",width:100},{title:"Số lượng danh mục",dataIndex:"quantity_cate",width:100},{title:"Số lượng sản phẩm AI đếm",children:[],width:300},{title:"Số lượng sản phẩm giám sát đếm",children:[],width:300},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(l){console.error("Error parsing item:",l)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:l=>{l.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(l){console.error("Error parsing item:",l)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:l=>{l.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const t=new Date(e),l=t.getDate(),a=t.getMonth()+1,i=t.getFullYear(),o=t.getHours(),g=t.getMinutes(),s=`${l.toString().padStart(2,"0")}/${a.toString().padStart(2,"0")}/${i} ${o.toString().padStart(2,"0")}:${g.toString().padStart(2,"0")}`;return n.jsx("div",{children:s})},width:120},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>n.jsxs(n.Fragment,{children:[e===1&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx($,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(N,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]}),width:120},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,t,l)=>n.jsx("div",{onClick:a=>{a.stopPropagation()},children:n.jsxs(h,{value:e,onChange:()=>q(t,l),bordered:k===l,onMouseEnter:()=>W(l),onMouseLeave:Y,suffixIcon:k===l?n.jsx(te,{}):null,children:[n.jsx(h.Option,{value:1,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx($,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),n.jsx(h.Option,{value:0,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx(N,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})}),width:120}]),[j,P]=d.useState([]),{search:oe}=$e();new URLSearchParams(oe).get("campaign");const ce=Ne(),[_,B]=d.useState([]),[de,he]=d.useState([]),[pe,X]=d.useState([]),ge=[{label:n.jsx("div",{onClick:()=>me(),className:"w-[200px]",children:"Cập nhật theo điều kiện AI"}),key:"0"},{type:"divider"},{label:n.jsx("div",{onClick:()=>ue(),children:"Cập nhật Đạt theo điều kiện lọc"}),key:"1"},{type:"divider"}],me=async()=>{if(S)if(j.length>0){const e=j.map(a=>({name:a.name,scoring_human:a.scoring_machine}));let t={data_list:JSON.stringify(e)},l="/api/method/mbw_audit.api.api.updatelistreport_scorehuman_by_AI";try{const a=await C.post(l,t);a&&a.message.status==="success"?(A(),p.success("Cập nhật thành công")):p.error("Cập nhật thất bại")}catch{p.error("Cập nhật thất bại")}}else p.warning("Danh sách đang trống. Không thể cập nhật");else if(_.length>0){const e=_.map(a=>({name:a.name,scoring_human:a.scoring_machine}));let t={data_list:JSON.stringify(e)},l="/api/method/mbw_audit.api.api.updatelistreport_scorehuman_by_AI";try{const a=await C.post(l,t);a&&a.message.status==="success"?(A(),p.success("Cập nhật thành công")):p.error("Cập nhật thất bại")}catch{p.error("Cập nhật thất bại")}}else p.warning("Danh sách đang trống. Không thể cập nhật")},ue=async()=>{if(S)if(j.length>0){const e=j.filter(a=>a.scoring_human===0).map(a=>({...a,scoring_human:1}));let t={data_list:JSON.stringify(e)},l="/api/method/mbw_audit.api.api.updatelistreport_scorehuman_by_AI";try{const a=await C.post(l,t);a&&a.message.status==="success"?(A(),p.success("Cập nhật thành công")):p.error("Cập nhật thất bại")}catch{p.error("Cập nhật thất bại")}}else p.warning("Danh sách đang trống. Không thể cập nhật");else if(_.length>0){const e=_.filter(a=>a.scoring_human===0).map(a=>({...a,scoring_human:1}));let t={data_list:JSON.stringify(e)},l="/api/method/mbw_audit.api.api.updatelistreport_scorehuman_by_AI";try{const a=await C.post(l,t);a&&a.message.status==="success"?(A(),p.success("Cập nhật thành công")):p.error("Cập nhật thất bại")}catch{p.error("Cập nhật thất bại")}}else p.warning("Danh sách đang trống. Không thể cập nhật")},V=(e,t)=>{localStorage.setItem("recordData",JSON.stringify(e)),localStorage.setItem("dataReports",JSON.stringify(_)),ce("/report-view")};d.useEffect(()=>{ye(),_e()},[]);const xe=[{title:"STT",dataIndex:"stt",fixed:"left",width:"5%"},{title:"Khách hàng",dataIndex:"customer_name",fixed:"left"},{title:"Tên chiến dịch",dataIndex:"campaign_name",fixed:"left"},{title:"Nhân viên thực hiện",dataIndex:"employee_name"},{title:"Số lượng danh mục",dataIndex:"quantity_cate"},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(l){console.error("Error parsing item:",l)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:l=>{l.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(l){console.error("Error parsing item:",l)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:l=>{l.stopPropagation(),t.length>0&&T(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const t=new Date(e),l=t.getDate(),a=t.getMonth()+1,i=t.getFullYear(),o=t.getHours(),g=t.getMinutes(),s=`${l.toString().padStart(2,"0")}/${a.toString().padStart(2,"0")}/${i} ${o.toString().padStart(2,"0")}:${g.toString().padStart(2,"0")}`;return n.jsx("div",{children:s})}},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>n.jsxs(n.Fragment,{children:[e===1&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx($,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(N,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,t,l)=>n.jsx("div",{onClick:a=>{a.stopPropagation()},children:n.jsxs(h,{value:e,onChange:()=>q(t,l),bordered:k===l,onMouseEnter:()=>W(l),onMouseLeave:Y,suffixIcon:k===l?n.jsx(te,{}):null,children:[n.jsx(h.Option,{value:1,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx($,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),n.jsx(h.Option,{value:0,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx(N,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})})}],fe=[{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Số lượng sản phẩm AI đếm",dataIndex:"sum_product"},{title:"Số lượng sản phẩm giám sát đếm",dataIndex:"sum_product_human"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>n.jsxs(n.Fragment,{children:[e===1&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx($,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(N,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}],A=async()=>{const e=JSON.parse(localStorage.getItem("campaign_dashboard"));e&&(H(e.campaign_code),D(!0),localStorage.removeItem("campaign_dashboard"));let t="/api/method/mbw_audit.api.api.get_reports_by_filter";if(b!=null&&b!=""&&b!="all"&&(t=`${t}?campaign_code=${b}`),I!=null&&I.length==2){let a=Math.round(new Date(I[0]).getTime()/1e3),i=Math.round(new Date(I[1]).getTime()/1e3);t.includes("?")?t=`${t}&start_date=${a}&end_date=${i}`:t=`${t}?start_date=${a}&end_date=${i}`}w!=null&&w!=""&&w!="all"&&(t.includes("?")?t=`${t}&employee_id=${w}`:t=`${t}?employee_id=${w}`),R!=null&&R!="all"&&(t.includes("?")?t=`${t}&status_scoring_ai=${R}`:t=`${t}?status_scoring_ai=${R}`,console.log(t)),E!=null&&E!="all"&&(t.includes("?")?t=`${t}&status_scoring_human=${E}`:t=`${t}?status_scoring_human=${E}`);let l=await C.get(t);if(l!=null&&l.message=="ok"&&l.result!=null&&l.result.data!=null){let a=l.result.data.map((i,o)=>{let g=(o+1).toString().padStart(2,"0"),s=JSON.parse(i.categories).length.toString().padStart(2,"0");return{...i,key:i.name,stt:g,quantity_cate:s}});if(!S)B(a);else{let i=!1,o=[],g=[];for(let s=0;s<a.length;s++){for(let m=0;m<a[s].info_products_ai.length;m++){if(!i){let r={title:a[s].info_products_ai[m].product_name,dataIndex:`${a[s].info_products_ai[m].product_name}_ai`,key:`${a[s].info_products_ai[m].product_name}_ai`,width:100},u={title:a[s].info_products_ai[m].product_name,dataIndex:`${a[s].info_products_ai[m].product_name}_human`,key:`${a[s].info_products_ai[m].product_name}_human`,width:100};o.push(r),g.push(u)}a[s][`${a[s].info_products_ai[m].product_name}_ai`]=a[s].info_products_ai[m].sum,a[s][`${a[s].info_products_human[m].product_name}_human`]=a[s].info_products_human[m].sum}o.length>0&&(i=!0)}U(s=>(s[5].children=o,s[6].children=g,s)),P(a)}}else S?(U(a=>(a[5].children=[],a[6].children=[],a)),P([])):B([])},W=e=>{F(e)},Y=()=>{F(!1)},q=async(e,t)=>{const l=e.scoring_human===1?0:1;let a={name:e.name,scoring_human:l};const o=await C.post("/api/method/mbw_audit.api.api.update_scorehuman_by_name",a);o!=null&&o.message=="ok"&&o.result!=null&&o.result.data=="success"?(p.success("Cập nhật thành công"),console.log(j),console.log(_),console.log(S),S?(console.log("13"),P(g=>{const s=[...g];return s[t].scoring_human=l,s})):(console.log("123"),B(g=>{const s=[...g];return s[t].scoring_human=l,s}))):p.error("Cập nhật thất bại")},ye=async()=>{try{const t=await C.get("/api/method/mbw_service_v2.api.ess.employee.get_list_employee");t&&t.result&&t.result.data&&he(t.result.data)}catch(e){console.error("Error fetching employee data:",e)}},_e=async()=>{const t=await C.get("/api/method/mbw_audit.api.api.get_all_campaigns");t!=null&&t.message=="ok"&&t.result!=null?X(t.result.data):X([])};d.useEffect(()=>{A()},[b,I,w,R,E]);const Se=()=>{S?je(j,L):ve(_,"Báo cáo chấm điểm trưng bày")},K=(e,t=!1)=>{const l={font:{bold:!0,name:"Times New Roman",size:12},alignment:{vertical:"middle",horizontal:"center"}};t&&(l.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}),e.style=l},je=async(e,t,l)=>{console.log(e),console.log(t);const a=new ne.Workbook,i=a.addWorksheet("Sheet1");let o=1;t.forEach((r,u)=>{const y=o;o===1?i.getColumn(o).width=10:i.getColumn(o).width=20;const f=i.getCell(1,o);if(f.value=r.title,K(f,!0),r.children&&r.children.length>0){const c=r.children.length;f.isMerged||i.mergeCells(1,o,1,o+c-1),r.children.forEach((v,M)=>{const Ae=y+M,ee=i.getCell(2,Ae);ee.value=v.title,K(ee)}),o+=c}else o++});let g=we(t);const s=3;e.forEach((r,u)=>{o=1,g.forEach((y,f)=>{const{dataIndex:c}=y;let x=null;r.hasOwnProperty(c)&&(c==="scoring_machine"||c==="scoring_human"?x=Ce(r[c]):x=r[c]);const v=i.getCell(s+u,o+f);v.value=x,K(v)})});const m=await a.xlsx.writeBuffer();G(m,"report")},Ce=e=>e===1?"Đạt":e===0?"Không đạt":"";function we(e){const t=[];function l(a){a.children&&a.children.length>0?a.children.forEach(i=>l(i)):t.push(a)}return e.forEach(a=>l(a)),t}const ve=async(e,t)=>{let l=e.map(r=>{const u=new Date(r.images_time),y=u.getDate(),f=u.getMonth()+1,c=u.getFullYear(),x=u.getHours(),v=u.getMinutes(),M=`${y.toString().padStart(2,"0")}/${f.toString().padStart(2,"0")}/${c} ${x.toString().padStart(2,"0")}:${v.toString().padStart(2,"0")}`;return r.images_time=M,r});const a=new ne.Workbook,i=a.addWorksheet("Sheet1");i.properties.defaultColWidth=20,i.getColumn("A").width=30,i.mergeCells("A2:J2"),i.getCell("A2").value=t,i.getCell("A2").style={font:{bold:!0,name:"Times New Roman",size:12}},i.getCell("A2").alignment={vertical:"middle",horizontal:"center"};let o=i.getRow(4),g=i.getRow(5),s=[{title:"Khách hàng",field:"customer_name"},{title:"Tên chiến dịch",field:"campaign_name"},{title:"Nhân viên thực hiện",field:"employee_name"},{title:"Số lượng danh mục",field:"categories"},{title:"Ảnh gian hàng",field:"images"},{title:"Ảnh gian hàng AI",field:"images_ai"},{title:"Thời gian thực hiện",field:"images_time"},{title:"Điểm trưng bày AI chấm",field:"scoring_machine"},{title:"Điểm trưng bày giám sát chấm",field:"scoring_human"}];for(let r=0;r<s.length;r++){let u=o.getCell(r+1),y=g.getCell(r+1);i.mergeCells(`${u._address}:${y._address}`),o.getCell(r+1).style={font:{bold:!0,name:"Times New Roman",size:12,italic:!0}},o.getCell(r+1).alignment={vertical:"middle",horizontal:"center"},o.getCell(r+1).value=s[r].title}for(let r=0;r<l.length;r++){let y=i.getRow(r+6),f=1;for(let c=0;c<s.length;c++){y.getCell(f).style={font:{name:"Times New Roman",size:12,italic:!0}};let x="";s[c].field=="categories"?l[r][s[c].field]!=null&&l[r][s[c].field]!=""&&(x=JSON.parse(l[r][s[c].field]).length):s[c].field=="scoring_machine"||s[c].field=="scoring_human"?l[r][s[c].field]==0?x="Không đạt":x="Đạt":x=l[r][s[c].field],y.getCell(f).value=x,f+=1}}const m=await a.xlsx.writeBuffer();G(m,"report")},G=(e,t)=>{let l="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8",a=".xlsx";const i=new Blob([e],{type:l});Fe.saveAs(i,t+"_export_"+new Date().getTime()+a)},be=e=>{H(e),console.log(e),e=="all"?D(!1):(console.log("true"),D(!0))},[Ie,Q]=d.useState([]),[Re,Z]=d.useState(!1),Ee=e=>{Z(!1),Q([])},O=(e,t)=>(t?.children??"").toLowerCase().includes(e.toLowerCase()),T=e=>{const t=JSON.parse(e);Q(t),Z(!0)};return n.jsxs(n.Fragment,{children:[n.jsx(ke,{title:"Báo cáo",buttons:[{label:"Xuất dữ liệu",type:"primary",icon:n.jsx(He,{className:"text-xl"}),size:"20px",className:"flex items-center",action:Se}]}),n.jsxs("div",{className:"bg-white rounded-xl",children:[n.jsx("div",{className:"flex p-4",style:{alignItems:"flex-end"},children:n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"flex-end"},children:[n.jsxs("div",{style:{display:"flex",flexDirection:"column",paddingRight:"15px"},children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Chiến dịch:"}),n.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:b,onChange:e=>be(e),defaultValue:"all",filterOption:O,optionFilterProp:"children",children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),pe.map(e=>n.jsx(h.Option,{value:e.name,children:e.campaign_name},e.name))]})]}),n.jsx(Oe,{className:"w-[250px] border-none mr-4",label:"Thời gian thực hiện",children:n.jsx(Je,{value:I,onChange:e=>le(e)})}),n.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Nhân viên:"}),n.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:w,onChange:e=>se(e),defaultValue:"all",filterOption:O,optionFilterProp:"children",children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),de.map(e=>n.jsx(h.Option,{value:e.name,children:e.employee_name},e.name))]})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm AI chấm:"}),n.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:R,onChange:e=>ie(e),defaultValue:"all",filterOption:O,optionFilterProp:"children",children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),J.map(e=>n.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm giám sát chấm:"}),n.jsxs(h,{className:"w-[150px] h-[36px]",value:E,onChange:e=>re(e),defaultValue:"all",filterOption:O,optionFilterProp:"children",showSearch:!0,children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),J.map(e=>n.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]})]}),n.jsx("div",{style:{display:"flex",alignItems:"flex-end"},children:n.jsx(Te,{menu:{items:ge},trigger:["click"],placement:"bottomRight",dropdownRender:e=>n.jsx("div",{className:"w-[200px]",children:De.cloneElement(e)}),children:n.jsx(Pe,{title:"Cập nhật danh sách báo cáo",children:n.jsx(Be,{type:"primary",icon:n.jsx(Ke,{})})})})})]})}),n.jsx("div",{children:S?n.jsx(z,{bordered:!0,columns:L,dataSource:j,pagination:j.length>5,scroll:{y:540,x:2e3},onRow:(e,t)=>({onClick:()=>V(e)}),rowHoverBg:"#f0f0f0"}):n.jsx(z,{bordered:!0,columns:xe,dataSource:_,scroll:{y:540,x:1300},pagination:_.length>5,onRow:(e,t)=>({onClick:()=>V(e)}),rowHoverBg:"#f0f0f0",expandable:{expandedRowRender:(e,t)=>n.jsx("div",{style:{margin:5},children:n.jsx(z,{columns:fe,dataSource:e.detail_skus,pagination:!1})})}})})]}),n.jsx(ae.PreviewGroup,{preview:{visible:Re,onVisibleChange:Ee},children:Ie.map((e,t)=>n.jsx(ae,{style:{display:"none"},width:50,src:e},t))})]})}function Ge(){return n.jsxs(n.Fragment,{children:[n.jsx(ze,{children:n.jsx("title",{children:"BÁO CÁO"})}),n.jsx(Le,{})]})}export{Ge as default};
