import{r as n,j as e,aL as me,C as J,g as A,a2 as Y,D as ue,S as Re,L as Ve,A as Q,a4 as Z,T as K,aM as he,M as ee,a3 as te,B as ne,a7 as Ke,a1 as se,aN as pe,aO as Le,s as M,a8 as ze,u as He,F as xe,H as Be,a5 as $e,aP as Ge,aa as We,d as Ye}from"./main-njtXoDmN.js";const Je=[{label:"Hoạt động",value:"Open"},{label:"Đóng",value:"Close"}];function Qe({form:x,onCampaignStatusChange:b}){const[N,h]=n.useState("Open"),g=y=>{h(y),b(y)};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-4 pt-6 pb-[58px]",children:[e.jsxs(me,{children:[e.jsx(J,{span:8,children:e.jsx(A,{label:"Tên chiến dịch",name:"campaign_name",required:!0,children:e.jsx(Y,{})})}),e.jsx(J,{span:8,children:e.jsx(A,{label:"Thời gian bắt đầu",name:"campaign_start",required:!0,children:e.jsx(ue,{className:"!bg-[#F4F6F8]",showTime:!0})})}),e.jsx(J,{span:8,children:e.jsx(A,{label:"Thời gian kết thúc",name:"campaign_end",required:!0,children:e.jsx(ue,{className:"!bg-[#F4F6F8]",showTime:!0})})})]}),e.jsxs(me,{className:"pt-2",children:[e.jsx(J,{span:8,children:e.jsx(A,{label:"Trạng thái",name:"campaign_status",children:e.jsx(Re,{defaultValue:"Open",options:Je,onChange:g})})}),e.jsx(J,{span:8,children:e.jsx(A,{label:"Mô tả",name:"campaign_description",children:e.jsx(Ve,{className:"bg-[#F5F7FA]",autoSize:{minRows:3,maxRows:5}})})})]})]})})}function Ue({onChangeCategory:x,onChangeCheckExistProduct:b,onChangeCheckSequenceProduct:N,onChangeSequenceProducts:h}){const[g,y]=n.useState(!1),[I,T]=n.useState(!1),[f,w]=n.useState([]),[C,D]=n.useState([]),[S,L]=n.useState([]),[R,k]=n.useState([]),[O,q]=n.useState([]),[E,p]=n.useState([]),[P,V]=n.useState(""),[z,H]=n.useState(""),[m,r]=n.useState([]),[d,u]=n.useState([]),[_,o]=n.useState([]),[j,B]=n.useState(!0),[$,F]=n.useState(!1),[le,ae]=n.useState([]);n.useState({}),n.useEffect(()=>{U()},[]),n.useEffect(()=>{U()},[P]);const U=async()=>{let t='/api/resource/VGM_Category?fields=["*"]';P!=null&&P!=""&&(t+=`&filters=[["category_name", "like", "%${P}%"]]`);const l=await Q.get(t);if(l&&l.data){let a=l.data.map(s=>({...s,key:s.name}));for(let s=0;s<a.length;s++){let c=`/api/resource/VGM_Product?fields=["name","product_code","product_name"]&&filters=[["category","=","${a[s].name}"]]&limit_page_length=500`,i=await Q.get(c);if(i!=null&&i.data!=null){a[s].product_num=i.data.length;let v=i.data.map(W=>({...W,key:W.name}));a[s].products=v}else a[s].product_num=0,a[s].products=[]}L(a)}},ce=t=>{V(t.target.value)},re=t=>{const l=t.target.value.toLowerCase();H(l);const a=[...O];if(l===""){k(O);return}else{const s=a.filter(c=>c.product_name.toLowerCase().includes(l));k(s)}},X=(t,l)=>{w(t)},G=(t,l)=>{const a=O.map((s,c)=>{const i=t.indexOf(s.name),v=i!==-1?i+1:null;return{...s,sequence_product:v}});k(a),D(t)},ge={selectedRowKeys:f,onChange:X},ye={selectedProductRowKeys:C,onChange:G},fe=()=>{let t=[],l=[];for(let a=0;a<f.length;a++){let s=S.filter(c=>c.name===f[a]);if(s!=null&&s.length>0){s[0].stt=t.length+1;let c={...s[0]};c.products=c.products.map(i=>({...i,cate_name:c.category_name,product_num:"1"})),l=l.concat(c.products),t.push(c)}}o(l),k(l),q(l),r(t),u(t),x(t),oe()},Se=()=>{const t=R.filter(s=>C.includes(s.name));let l=t.map(s=>s.name);h(l);const a=t.sort((s,c)=>{const i=parseInt(s.sequence_product),v=parseInt(c.sequence_product);return i-v});p(a),de()},je=f.length>0,Ce=C.length>0,ke=()=>{y(!0)},_e=()=>{T(!0)},be=()=>{y(!1)},oe=()=>{y(!1)},de=()=>{T(!1)},we=t=>{const l=m.filter(c=>c.name!==t.name).map((c,i)=>({...c,stt:i+1})),a=_.filter(c=>c.cate_name!==t.category_name);if(o(a),k(a),E.length>0){const c=E.filter(W=>W.cate_name!==t.category_name);let i=1;const v=c.map(W=>(W.sequence_product=i++,W));p(v)}q(a),r(l);const s=l.map(c=>({...c,products:c.products.filter(i=>_.some(v=>v.name===i.name))}));x(s)},Pe=t=>{t.stopPropagation(),B(t.target.checked),b(t.target.checked)},ve=t=>{F(t.target.checked),N(t.target.checked)},Ne=(t,l)=>{const a=[{title:"Mã sản phẩm",dataIndex:"product_code",key:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name",key:"product_name"}];return e.jsx(e.Fragment,{children:e.jsx("div",{style:{margin:5},children:e.jsx(Ke,{columns:a,dataSource:t.products,pagination:!1})})})},Ie=[{title:"STT",dataIndex:"stt",key:"stt"},{title:"Danh mục sản phẩm",dataIndex:"category_name",key:"category_name"},{title:"Số lượng sản phẩm",dataIndex:"product_num",key:"product_num"},{title:"",key:"",render:t=>e.jsx(se,{onClick:()=>we(t)})}],Te=[{title:"Mã sản phẩm",dataIndex:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Danh mục",dataIndex:"cate_name"},{title:"Số lượng ít nhất",dataIndex:"product_num",render:(t,l,a)=>e.jsx(Y,{style:{width:"120px"},min:1,defaultValue:t,onChange:s=>{const c=parseInt(s.target.value);!isNaN(c)&&c>=1?ie(a,c):(M.warning("Số lượng ít nhất là 1"),ie(a,1))}})},{title:"",key:"",render:t=>e.jsx(se,{onClick:()=>Ee(t)})}],Ee=t=>{const l=_.filter(s=>s.name!==t.name);o(l);const a=d.map(s=>({...s,products:s.products.filter(c=>l.some(i=>i.name===c.name))}));u(a),x(a)},De=[{key:"sort"},{title:"STT",dataIndex:"sequence_product"},{title:"Mã sản phẩm",dataIndex:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Danh mục",dataIndex:"cate_name"}],ie=(t,l)=>{const a=[..._];a[t].product_num=l,o(a);const s=d.map(c=>({...c,products:c.products.filter(i=>a.some(v=>v.name===i.name))}));u(s),x(s)},Oe=(t,l)=>{k(a=>a.map((s,c)=>{if(c===t){const i=s.sequence_product||0;return{...s,sequence_product:i+l}}return s}))},qe=t=>{let l=t.map(a=>a.name);ae(l),h(l)},Fe=[{key:"1",label:e.jsxs(pe,{checked:j,onClick:t=>{t.stopPropagation()},onChange:Pe,children:[" ",e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},onClick:t=>{t.stopPropagation()},children:[" ","1. Tiêu chí tồn tại sản phẩm"]})," "]}),children:e.jsx("div",{className:"m-3",children:e.jsx(K,{columns:Te,dataSource:_})})},{key:"2",label:e.jsxs(pe,{onClick:t=>{t.stopPropagation()},checked:$,onChange:ve,children:[" ",e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},onClick:t=>{t.stopPropagation()},children:[" ","2. Tiêu chí sắp xếp sản phẩm"]})," "]}),children:e.jsxs("div",{children:[e.jsxs("div",{onClick:_e,className:"flex justify-center h-9 cursor-pointer items-center ml-4 mt-4 mb-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px] ",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn sản phẩm"})]}),e.jsx("div",{className:"ml-4 mb-4 mr-4 mt-4",style:{fontSize:"17px",fontStyle:"italic",fontWeight:400,lineHeight:"21px",letterSpacing:"0em",textAlign:"left",color:"rgba(99, 115, 129, 1)"},children:e.jsx("span",{children:"Di chuyển (kéo, thả) các sản phẩm để sắp xếp thứ tự sản phẩm"})}),e.jsx(Le,{columnsTable:De,datasTable:E,keyPros:"sequence_product",onDragRowEvent:qe})]})}],Me=[{key:"1",label:e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},children:[" ","Thiết lập tiêu chí chấm điểm trưng bày sản phẩm"]}),children:e.jsx(he,{items:Fe,defaultActiveKey:["1","2"],className:"custom-collapse-audit"})}],Ae=t=>{};return e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách sản phẩm"}),e.jsxs("div",{onClick:ke,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn danh mục"})]}),e.jsxs("div",{className:"pt-6 mx-4",children:[e.jsx(K,{columns:Ie,expandable:{expandedRowRender:Ne,defaultExpandedRowKeys:["0"]},dataSource:m}),e.jsx(he,{items:Me,defaultActiveKey:["1","2"],onChange:Ae,className:"custom-collapse-parent"})]}),e.jsxs(ee,{width:990,title:"Chọn danh mục sản phẩm",open:g,onOk:be,onCancel:oe,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:P,onChange:ce,placeholder:"Tìm kiếm danh mục sản phẩm",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:je?`Đã chọn ${f.length} danh mục`:""}),e.jsx(ne,{type:"primary",onClick:fe,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:ge,columns:[{title:"Danh mục sản phẩm",dataIndex:"category_name",key:"category_name"},{title:"Số lượng sản phẩm",dataIndex:"product_num",key:"product_num"}],dataSource:S})})]}),e.jsxs(ee,{width:990,title:"Sắp xếp sản phẩm",open:I,onCancel:de,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:z,onChange:re,placeholder:"Tìm kiếm sản phẩm",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:Ce?`Đã chọn ${C.length} sản phẩm`:""}),e.jsx(ne,{type:"primary",onClick:Se,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:ye,scroll:{y:350},columns:[{title:"Mã sản phẩm",dataIndex:"product_code",key:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name",key:"product_name"},{title:"Danh mục",dataIndex:"cate_name",key:"cate_name"},{title:"Chọn thứ tự",dataIndex:"sequence_product",render:(t,l,a)=>e.jsx(Y,{style:{width:"120px"},defaultValue:t,value:t,onChange:s=>Oe(a,parseInt(s.target.value))})}],dataSource:R})})]})]})}function Xe({onChangeCustomer:x}){const b=ze.apiUrl,[N,h]=n.useState(!1),[g,y]=n.useState([]),[I,T]=n.useState([]),[f,w]=n.useState([]),[C,D]=n.useState([]),[S,L]=n.useState(""),R=[{title:"ID",dataIndex:"customer_code",key:"customer_code"},{title:"Tên khách hàng",key:"customer_name",dataIndex:"customer_name"},{title:"Nhóm khách hàng",dataIndex:"customer_group",key:"customer_group"},{title:"Địa chỉ",key:"customer_primary_address",dataIndex:"customer_primary_address"},{title:"",key:"action",render:(r,d)=>e.jsx("a",{children:e.jsx(se,{onClick:()=>z(d)})})}];n.useEffect(()=>{k()},[]),n.useEffect(()=>{let r=f;S!=null&&S!=""&&(r=f.filter(d=>d.customer_name.toLowerCase().includes(S.toLowerCase()))),T(r)},[S]);const k=async()=>{let r=b+".api.get_list_customers";console.log(r);let d=await Q.get(r),u=[];d!=null&&d.message=="ok"&&(u=d.result.data.map(_=>({..._,key:_.name}))),T(u),w(u)},O=()=>{h(!0)},q=()=>{h(!1)},E=()=>{h(!1)},p=r=>{L(r.target.value)},P=r=>{y(r)},V=()=>{let r=[];for(let d=0;d<g.length;d++){let u=I.filter(_=>_.name==g[d]);u!=null&&u.length>0&&r.push(u[0])}D(r),x(r),E()},z=r=>{const d=C.filter(u=>u.name!==r.name);D(d),x(d)},H={selectedRowKeys:g,onChange:P},m=g.length>0;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách khách hàng"}),e.jsxs("div",{onClick:O,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn khách hàng"})]}),e.jsx("div",{className:"pt-6 mx-4",children:e.jsx(K,{columns:R,dataSource:C})}),e.jsxs(ee,{width:990,title:"Chọn khách hàng",open:N,onOk:q,onCancel:E,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:S,onChange:p,placeholder:"Tìm kiếm tên khách hàng",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:m?`Đã chọn ${g.length} khách hàng`:""}),e.jsx(ne,{type:"primary",onClick:V,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:H,columns:[{title:"ID",dataIndex:"customer_code",key:"customer_code"},{title:"Tên khách hàng",key:"customer_name",dataIndex:"customer_name"},{title:"Nhóm khách hàng",dataIndex:"customer_group",key:"customer_group"},{title:"Địa chỉ",key:"customer_primary_address",dataIndex:"customer_primary_address"}],dataSource:I})})]})]})})}const Ze=[{title:"Mã nhân viên",dataIndex:"name",key:"name"},{title:"Tên nhân viên",dataIndex:"employee_name",key:"employee_name"},{title:"Email",dataIndex:"email",key:"email"}];function et({onChangeEmployees:x}){const[b,N]=n.useState(!1),[h,g]=n.useState([]),[y,I]=n.useState([]),[T,f]=n.useState([]),[w,C]=n.useState(""),[D,S]=n.useState([]),L=[{title:"Mã nhân viên",dataIndex:"name",key:"name"},{title:"Tên nhân viên",dataIndex:"employee_name",key:"employee_name"},{title:"Email",dataIndex:"email",key:"email"},{title:"",key:"",render:m=>e.jsx("a",{children:e.jsx(se,{onClick:()=>V(m)})})}];n.useEffect(()=>{R()},[]),n.useEffect(()=>{let m=T;w!=null&&w!=""&&(m=T.filter(r=>r.employee_name.toLowerCase().includes(w.toLowerCase()))),I(m)},[w]);const R=async()=>{let r=await Q.get("/api/method/mbw_audit.api.api.get_list_employees"),d=[];r!=null&&r.result!=null&&r.result.data!=null&&(d=r.result.data.map(u=>({...u,email:u.personal_email,key:u.name}))),I(d),f(d)},k=()=>{N(!0)},O=()=>{N(!1)},q=()=>{N(!1)},E=m=>{g(m)},p=m=>{C(m.target.value)},P=()=>{let m=[];for(let r=0;r<h.length;r++){let d=y.filter(u=>u.name==h[r]);d!=null&&d.length>0&&m.push(d[0])}S(m),x(m),q()},V=m=>{const r=D.filter(d=>d.name!==m.name);S(r),x(r)},z={selectedRowKeys:h,onChange:E},H=h.length>0;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách nhân viên"}),e.jsxs("div",{onClick:k,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(Z,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn nhân viên"})]}),e.jsx("div",{className:"pt-6 mx-4",children:e.jsx(K,{columns:L,dataSource:D})}),e.jsxs(ee,{width:990,title:"Chọn nhân viên",open:b,onOk:O,onCancel:q,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{className:"w-[320px] border-none pt-4",children:e.jsx(Y,{value:w,onChange:p,placeholder:"Tìm kiếm tên nhân viên",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:H?`Đã chọn ${h.length} nhân viên`:""}),e.jsx(ne,{type:"primary",onClick:P,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(K,{rowSelection:z,columns:Ze,dataSource:y})})]})]})})}function tt(){const x=He(),[b]=xe.useForm(),[N,h]=n.useState("Open"),[g,y]=n.useState([]),[I,T]=n.useState([]),[f,w]=n.useState([]),[C,D]=n.useState({}),[S,L]=n.useState(!0),[R,k]=n.useState(!1),[O,q]=n.useState([]),[E,p]=n.useState(!1),P=async()=>{try{p(!0);let o=b.getFieldsValue(),j=V(o.campaign_start),B=V(o.campaign_end);if(j>=B){M.error("Thời gian bắt đầu phải nhỏ hơn Thời gian kết thúc"),p(!1);return}let $={},F=Object.getOwnPropertyNames(C);if(S&&($.min_product=C.min_product),R&&($.sequence_product=O),g.length===0){M.error("Vui lòng điền thông tin sản phẩm"),p(!1);return}if(I.length===0){M.error("Vui lòng chọn ít nhất một nhân viên."),p(!1);return}if(f.length===0){M.error("Vui lòng chọn ít nhất một khách hàng."),p(!1);return}if(o.campaign_name==null||o.campaign_name==""){M.error("Vui lòng nhập tên chiến dịch."),p(!1);return}let le=g.map(G=>G.name),ae=I.map(G=>G.name),U=f.map(G=>G.name),ce="/api/resource/VGM_Campaign",re={campaign_name:o.campaign_name,campaign_description:o.campaign_description,start_date:j,end_date:B,campaign_status:N,categories:JSON.stringify(le),employees:JSON.stringify(ae),retails:JSON.stringify(U),setting_score_audit:$},X=await Q.post(ce,re);X!=null&&X.data!=null?(M.success("Thêm mới thành công"),p(!1),x("/campaign")):(M.error("Thêm mới thất bại"),p(!1))}catch{M.error("Không thể thêm mới. Vui lòng kiểm tra lại thông tin thời gian, sản phẩm, nhân viên, khách hàng"),p(!1)}},V=o=>{const j=new Date(o),B=We(j).format("YYYY-MM-DD HH:mm:ss");return j.toISOString().slice(0,19).replace("T"," "),B},z=o=>{h(o)},H=o=>{y(o);const j={};o.forEach($=>{$.products.forEach(F=>{j.hasOwnProperty(F.key)?j[F.key]=Math.min(j[F.key],parseInt(F.product_num)):j[F.key]=parseInt(F.product_num)})}),D({min_product:j})},m=o=>{T(o)},r=o=>{w(o)},d=o=>{L(o)},u=o=>{k(o)},_=o=>{q(o)};return e.jsxs(e.Fragment,{children:[e.jsx(Be,{title:"Thêm mới chiến dịch",icon:e.jsx("p",{onClick:()=>x("/campaign"),className:"mr-2 cursor-pointer",children:e.jsx($e,{})}),buttons:[{label:"Thêm mới",type:"primary",size:"20px",className:"flex items-center",loading:E,action:P}]}),e.jsx("div",{className:"bg-white pt-4 rounded-xl border-[#DFE3E8] border-[0.2px] border-solid",children:e.jsx(xe,{layout:"vertical",form:b,children:e.jsx(Ge,{defaultActiveKey:"1",items:[{label:e.jsx("p",{className:"px-4 mb-0",children:" Thông tin chung"}),key:"1",children:e.jsx(Qe,{form:b,onCampaignStatusChange:z})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Sản phẩm"}),key:"2",children:e.jsx(Ue,{onChangeCategory:H,onChangeCheckExistProduct:d,onChangeCheckSequenceProduct:u,onChangeSequenceProducts:_})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Nhân viên bán hàng"}),key:"3",children:e.jsx(et,{onChangeEmployees:m})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Khách hàng"}),key:"4",children:e.jsx(Xe,{onChangeCustomer:r})}],indicatorSize:o=>o-18})})})]})}function st(){return e.jsxs(e.Fragment,{children:[e.jsx(Ye,{children:e.jsx("title",{children:" Campaign Create"})}),e.jsx(tt,{})]})}export{st as default};
