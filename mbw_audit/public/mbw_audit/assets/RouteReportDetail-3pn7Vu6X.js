import{r as c,j as n,S as h,e as Z,f as Ee,u as $e,A as T,s as ee,H as Re,g as Ae,T as B,D as Te,d as Ne}from"./main-gEQUCC_S.js";import{V as Oe,e as te,F as ke}from"./FileSaver.min-OhxzTE9k.js";import{C as w,a as I}from"./CloseCircleOutlined-jAPyUPYG.js";import{I as ne}from"./index-0vRfQ8J4.js";const{RangePicker:De}=Te;function Pe(){const[S,M]=c.useState("all"),[j,ae]=c.useState([]),[y,le]=c.useState("all"),[C,ie]=c.useState("all"),[v,se]=c.useState("all"),[b,z]=c.useState(null);c.useState(!1);const[F,Be]=c.useState([{label:"Đạt",value:1},{label:"Không đạt",value:0}]),[E,N]=c.useState(!1),[H,K]=c.useState([{title:"STT",dataIndex:"stt",width:50},{title:"Khách hàng",dataIndex:"customer_name",width:100},{title:"Tên chiến dịch",dataIndex:"campaign_name",width:100},{title:"Nhân viên thực hiện",dataIndex:"employee_name",width:100},{title:"Số lượng danh mục",dataIndex:"quantity_cate",width:100},{title:"Số lượng sản phẩm AI đếm",children:[],width:300},{title:"Số lượng sản phẩm giám sát đếm",children:[],width:300},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),t.length>0&&A(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),t.length>0&&A(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})},width:120},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const t=new Date(e),a=t.getDate(),l=t.getMonth()+1,s=t.getFullYear(),o=t.getHours(),m=t.getMinutes(),i=`${a.toString().padStart(2,"0")}/${l.toString().padStart(2,"0")}/${s} ${o.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;return n.jsx("div",{children:i})},width:120},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>n.jsxs(n.Fragment,{children:[e===1&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]}),width:120},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,t,a)=>n.jsx("div",{onClick:l=>{l.stopPropagation()},children:n.jsxs(h,{defaultValue:e,onChange:()=>W(t,a),bordered:b===a,onMouseEnter:()=>X(a),onMouseLeave:U,suffixIcon:b===a?n.jsx(Z,{}):null,children:[n.jsx(h.Option,{value:1,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),n.jsx(h.Option,{value:0,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})}),width:120}]),[O,J]=c.useState([]),{search:re}=Ee();new URLSearchParams(re).get("campaign");const oe=$e(),[$,k]=c.useState([]),[de,ce]=c.useState([]),[he,L]=c.useState([]),V=(e,t)=>{localStorage.setItem("recordData",JSON.stringify(e)),localStorage.setItem("dataReports",JSON.stringify($)),oe("/report-view")};c.useEffect(()=>{ue(),xe()},[]);const ge=[{title:"STT",dataIndex:"stt",fixed:"left",width:"5%"},{title:"Khách hàng",dataIndex:"customer_name",fixed:"left"},{title:"Tên chiến dịch",dataIndex:"campaign_name",fixed:"left"},{title:"Nhân viên thực hiện",dataIndex:"employee_name"},{title:"Số lượng danh mục",dataIndex:"quantity_cate"},{title:"Ảnh gian hàng",dataIndex:"images",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),t.length>0&&A(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Ảnh gian hàng AI",dataIndex:"images_ai",render:e=>{let t=[];if(e!==null)try{t=JSON.parse(e)}catch(a){console.error("Error parsing item:",a)}return n.jsx("a",{style:{cursor:t.length>0?"pointer":"default"},onClick:a=>{a.stopPropagation(),t.length>0&&A(e)},children:t.length>0?"Xem hình ảnh":"Không có hình ảnh"})}},{title:"Thời gian thực hiện",dataIndex:"images_time",render:e=>{const t=new Date(e),a=t.getDate(),l=t.getMonth()+1,s=t.getFullYear(),o=t.getHours(),m=t.getMinutes(),i=`${a.toString().padStart(2,"0")}/${l.toString().padStart(2,"0")}/${s} ${o.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;return n.jsx("div",{children:i})}},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>n.jsxs(n.Fragment,{children:[e===1&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})},{title:"Điểm trưng bày giám sát chấm",dataIndex:"scoring_human",render:(e,t,a)=>n.jsx("div",{onClick:l=>{l.stopPropagation()},children:n.jsxs(h,{defaultValue:e,onChange:()=>W(t,a),bordered:b===a,onMouseEnter:()=>X(a),onMouseLeave:U,suffixIcon:b===a?n.jsx(Z,{}):null,children:[n.jsx(h.Option,{value:1,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}}),n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]})}),n.jsx(h.Option,{value:0,children:n.jsxs("span",{style:{display:"flex"},children:[n.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}}),n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})})]})})}],me=[{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Số lượng sản phẩm AI đếm",dataIndex:"sum_product"},{title:"Số lượng sản phẩm giám sát đếm",dataIndex:"sum_product_human"},{title:"Điểm trưng bày AI chấm",dataIndex:"scoring_machine",render:e=>n.jsxs(n.Fragment,{children:[e===1&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(w,{style:{fontSize:"17px",color:"green",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"green",verticalAlign:"middle"},children:"Đạt"})]}),e===0&&n.jsxs("span",{style:{display:"flex"},children:[n.jsx(I,{style:{fontSize:"17px",color:"red",paddingRight:"3px"}})," ",n.jsx("span",{style:{color:"red",verticalAlign:"middle"},children:"Không đạt"})]})]})}],pe=async()=>{const e=JSON.parse(localStorage.getItem("campaign_dashboard"));e&&(M(e.campaign_code),N(!0),localStorage.removeItem("campaign_dashboard"));let t="/api/method/mbw_audit.api.api.get_reports_by_filter";if(S!=null&&S!=""&&S!="all"&&(t=`${t}?campaign_code=${S}`),j!=null&&j.length==2){let l=Math.round(new Date(j[0]).getTime()/1e3),s=Math.round(new Date(j[1]).getTime()/1e3);t.includes("?")?t=`${t}&start_date=${l}&end_date=${s}`:t=`${t}?start_date=${l}&end_date=${s}`}y!=null&&y!=""&&y!="all"&&(t.includes("?")?t=`${t}&employee_id=${y}`:t=`${t}?employee_id=${y}`),C!=null&&C!="all"&&(t.includes("?")?t=`${t}&status_scoring_ai=${C}`:t=`${t}?status_scoring_ai=${C}`,console.log(t)),v!=null&&v!="all"&&(t.includes("?")?t=`${t}&status_scoring_human=${v}`:t=`${t}?status_scoring_human=${v}`);let a=await T.get(t);if(a!=null&&a.message=="ok"&&a.result!=null&&a.result.data!=null){let l=a.result.data.map((s,o)=>{let m=(o+1).toString().padStart(2,"0"),i=JSON.parse(s.categories).length.toString().padStart(2,"0");return{...s,key:s.name,stt:m,quantity_cate:i}});if(!E)k(l);else{let s=!1,o=[],m=[];for(let i=0;i<l.length;i++){for(let g=0;g<l[i].info_products_ai.length;g++){if(!s){let r={title:l[i].info_products_ai[g].product_name,dataIndex:`${l[i].info_products_ai[g].product_name}_ai`,key:`${l[i].info_products_ai[g].product_name}_ai`,width:100},p={title:l[i].info_products_ai[g].product_name,dataIndex:`${l[i].info_products_ai[g].product_name}_human`,key:`${l[i].info_products_ai[g].product_name}_human`,width:100};o.push(r),m.push(p)}l[i][`${l[i].info_products_ai[g].product_name}_ai`]=l[i].info_products_ai[g].sum,l[i][`${l[i].info_products_human[g].product_name}_human`]=l[i].info_products_human[g].sum}o.length>0&&(s=!0)}K(i=>(i[5].children=o,i[6].children=m,i)),J(l)}}else E?(K(l=>(l[5].children=[],l[6].children=[],l)),J([])):k([])},X=e=>{z(e)},U=()=>{z(!1)},W=async(e,t)=>{const a=e.scoring_human===1?0:1;let l={name:e.name,scoring_human:a};const o=await T.post("/api/method/mbw_audit.api.api.update_scorehuman_by_name",l);o!=null&&o.message=="ok"&&o.result!=null&&o.result.data=="success"?(ee.success("Cập nhật thành công"),k(m=>{const i=[...m];return i[t].scoring_human=a,i})):ee.error("Cập nhật thất bại")},ue=async()=>{try{const t=await T.get("/api/method/mbw_service_v2.api.ess.employee.get_list_employee");t&&t.result&&t.result.data&&ce(t.result.data)}catch(e){console.error("Error fetching employee data:",e)}},xe=async()=>{const t=await T.get("/api/method/mbw_audit.api.api.get_all_campaigns");t!=null&&t.message=="ok"&&t.result!=null?L(t.result.data):L([])};c.useEffect(()=>{pe()},[S,j,y,C,v]);const fe=()=>{E?ye(O,H):je($,"Báo cáo chấm điểm trưng bày")},D=(e,t=!1)=>{const a={font:{bold:!0,name:"Times New Roman",size:12},alignment:{vertical:"middle",horizontal:"center"}};t&&(a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}),e.style=a},ye=async(e,t,a)=>{console.log(e),console.log(t);const l=new te.Workbook,s=l.addWorksheet("Sheet1");let o=1;t.forEach((r,p)=>{const f=o;o===1?s.getColumn(o).width=10:s.getColumn(o).width=20;const x=s.getCell(1,o);if(x.value=r.title,D(x,!0),r.children&&r.children.length>0){const d=r.children.length;x.isMerged||s.mergeCells(1,o,1,o+d-1),r.children.forEach((_,P)=>{const be=f+P,Q=s.getCell(2,be);Q.value=_.title,D(Q)}),o+=d}else o++});let m=Se(t);const i=3;e.forEach((r,p)=>{o=1,m.forEach((f,x)=>{const{dataIndex:d}=f;let u=null;r.hasOwnProperty(d)&&(d==="scoring_machine"||d==="scoring_human"?u=_e(r[d]):u=r[d]);const _=s.getCell(i+p,o+x);_.value=u,D(_)})});const g=await l.xlsx.writeBuffer();Y(g,"report")},_e=e=>e===1?"Đạt":e===0?"Không đạt":"";function Se(e){const t=[];function a(l){l.children&&l.children.length>0?l.children.forEach(s=>a(s)):t.push(l)}return e.forEach(l=>a(l)),t}const je=async(e,t)=>{let a=e.map(r=>{const p=new Date(r.images_time),f=p.getDate(),x=p.getMonth()+1,d=p.getFullYear(),u=p.getHours(),_=p.getMinutes(),P=`${f.toString().padStart(2,"0")}/${x.toString().padStart(2,"0")}/${d} ${u.toString().padStart(2,"0")}:${_.toString().padStart(2,"0")}`;return r.images_time=P,r});const l=new te.Workbook,s=l.addWorksheet("Sheet1");s.properties.defaultColWidth=20,s.getColumn("A").width=30,s.mergeCells("A2:J2"),s.getCell("A2").value=t,s.getCell("A2").style={font:{bold:!0,name:"Times New Roman",size:12}},s.getCell("A2").alignment={vertical:"middle",horizontal:"center"};let o=s.getRow(4),m=s.getRow(5),i=[{title:"Khách hàng",field:"customer_name"},{title:"Tên chiến dịch",field:"campaign_name"},{title:"Nhân viên thực hiện",field:"employee_name"},{title:"Số lượng danh mục",field:"categories"},{title:"Ảnh gian hàng",field:"images"},{title:"Ảnh gian hàng AI",field:"images_ai"},{title:"Thời gian thực hiện",field:"images_time"},{title:"Điểm trưng bày AI chấm",field:"scoring_machine"},{title:"Điểm trưng bày giám sát chấm",field:"scoring_human"}];for(let r=0;r<i.length;r++){let p=o.getCell(r+1),f=m.getCell(r+1);s.mergeCells(`${p._address}:${f._address}`),o.getCell(r+1).style={font:{bold:!0,name:"Times New Roman",size:12,italic:!0}},o.getCell(r+1).alignment={vertical:"middle",horizontal:"center"},o.getCell(r+1).value=i[r].title}for(let r=0;r<a.length;r++){let f=s.getRow(r+6),x=1;for(let d=0;d<i.length;d++){f.getCell(x).style={font:{name:"Times New Roman",size:12,italic:!0}};let u="";i[d].field=="categories"?a[r][i[d].field]!=null&&a[r][i[d].field]!=""&&(u=JSON.parse(a[r][i[d].field]).length):i[d].field=="scoring_machine"||i[d].field=="scoring_human"?a[r][i[d].field]==0?u="Không đạt":u="Đạt":u=a[r][i[d].field],f.getCell(x).value=u,x+=1}}const g=await l.xlsx.writeBuffer();Y(g,"report")},Y=(e,t)=>{let a="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8",l=".xlsx";const s=new Blob([e],{type:a});ke.saveAs(s,t+"_export_"+new Date().getTime()+l)},Ce=e=>{M(e),e=="all"?N(!1):N(!0)},[ve,q]=c.useState([]),[we,G]=c.useState(!1),Ie=e=>{G(!1),q([])},R=(e,t)=>(t?.children??"").toLowerCase().includes(e.toLowerCase()),A=e=>{const t=JSON.parse(e);q(t),G(!0)};return n.jsxs(n.Fragment,{children:[n.jsx(Re,{title:"Báo cáo",buttons:[{label:"Xuất dữ liệu",type:"primary",icon:n.jsx(Oe,{className:"text-xl"}),size:"20px",className:"flex items-center",action:fe}]}),n.jsxs("div",{className:"bg-white rounded-xl",children:[n.jsxs("div",{className:"flex p-4",style:{alignItems:"flex-end"},children:[n.jsxs("div",{style:{display:"flex",flexDirection:"column",paddingRight:"15px"},children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Chiến dịch:"}),n.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:S,onChange:e=>Ce(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),he.map(e=>n.jsx(h.Option,{value:e.name,children:e.campaign_name},e.name))]})]}),n.jsx(Ae,{className:"w-[250px] border-none mr-4",label:"Thời gian thực hiện",children:n.jsx(De,{value:j,onChange:e=>ae(e)})}),n.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Nhân viên:"}),n.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:y,onChange:e=>le(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),de.map(e=>n.jsx(h.Option,{value:e.name,children:e.employee_name},e.name))]})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm AI chấm:"}),n.jsxs(h,{showSearch:!0,className:"w-[150px] h-[36px]",value:C,onChange:e=>ie(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),F.map(e=>n.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column"},className:"mr-4",children:[n.jsx("label",{style:{paddingBottom:"5px"},children:"Điểm giám sát chấm:"}),n.jsxs(h,{className:"w-[150px] h-[36px]",value:v,onChange:e=>se(e),defaultValue:"all",filterOption:R,optionFilterProp:"children",showSearch:!0,children:[n.jsx(h.Option,{value:"all",children:"Tất cả"}),F.map(e=>n.jsx(h.Option,{value:e.value,children:e.label},e.value))]})]})]}),n.jsx("div",{children:E?n.jsx(B,{bordered:!0,columns:H,dataSource:O,pagination:O.length>5,scroll:{y:540,x:2e3},onRow:(e,t)=>({onClick:()=>V(e)}),rowHoverBg:"#f0f0f0"}):n.jsx(B,{bordered:!0,columns:ge,dataSource:$,scroll:{y:540,x:1300},pagination:$.length>5,onRow:(e,t)=>({onClick:()=>V(e)}),rowHoverBg:"#f0f0f0",expandable:{expandedRowRender:(e,t)=>n.jsx("div",{style:{margin:5},children:n.jsx(B,{columns:me,dataSource:e.detail_skus,pagination:!1})})}})})]}),n.jsx(ne.PreviewGroup,{preview:{visible:we,onVisibleChange:Ie},children:ve.map((e,t)=>n.jsx(ne,{style:{display:"none"},width:50,src:e},t))})]})}function Je(){return n.jsxs(n.Fragment,{children:[n.jsx(Ne,{children:n.jsx("title",{children:"BÁO CÁO"})}),n.jsx(Pe,{})]})}export{Je as default};
