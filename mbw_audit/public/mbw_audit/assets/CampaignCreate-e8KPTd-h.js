import{r as n,j as e,aJ as me,C as W,g as F,Z as J,D as ue,S as Re,G as Ve,A as Q,a0 as X,T as V,aK as he,a1 as ee,$ as te,a2 as ne,a5 as Ke,Y as se,aL as pe,aM as Le,s as R,u as ze,F as xe,H as He,a3 as $e,aN as Be,a8 as Ge,d as Ye}from"./main-RjEGH6bh.js";const Je=[{label:"Hoạt động",value:"Open"},{label:"Đóng",value:"Close"}];function We({form:x,onCampaignStatusChange:b}){const[S,u]=n.useState("Open"),v=g=>{u(g),b(g)};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-4 pt-6 pb-[58px]",children:[e.jsxs(me,{children:[e.jsx(W,{span:8,children:e.jsx(F,{label:"Tên chiến dịch",name:"campaign_name",required:!0,children:e.jsx(J,{})})}),e.jsx(W,{span:8,children:e.jsx(F,{label:"Thời gian bắt đầu",name:"campaign_start",required:!0,children:e.jsx(ue,{className:"!bg-[#F4F6F8]",showTime:!0})})}),e.jsx(W,{span:8,children:e.jsx(F,{label:"Thời gian kết thúc",name:"campaign_end",required:!0,children:e.jsx(ue,{className:"!bg-[#F4F6F8]",showTime:!0})})})]}),e.jsxs(me,{className:"pt-2",children:[e.jsx(W,{span:8,children:e.jsx(F,{label:"Trạng thái",name:"campaign_status",children:e.jsx(Re,{defaultValue:"Open",options:Je,onChange:v})})}),e.jsx(W,{span:8,children:e.jsx(F,{label:"Mô tả",name:"campaign_description",children:e.jsx(Ve,{className:"bg-[#F5F7FA]",autoSize:{minRows:3,maxRows:5}})})})]})]})})}function Qe({onChangeCategory:x,onChangeCheckExistProduct:b,onChangeCheckSequenceProduct:S,onChangeSequenceProducts:u}){const[v,g]=n.useState(!1),[N,I]=n.useState(!1),[f,C]=n.useState([]),[j,k]=n.useState([]),[E,K]=n.useState([]),[A,_]=n.useState([]),[D,T]=n.useState([]),[q,h]=n.useState([]),[w,M]=n.useState(""),[L,z]=n.useState(""),[r,o]=n.useState([]),[i,p]=n.useState([]),[H,d]=n.useState([]),[y,$]=n.useState(!0),[B,O]=n.useState(!1),[oe,ae]=n.useState([]);n.useState({}),n.useEffect(()=>{Z()},[]),n.useEffect(()=>{Z()},[w]);const Z=async()=>{let t='/api/resource/VGM_Category?fields=["*"]';w!=null&&w!=""&&(t+=`&filters=[["category_name", "like", "%${w}%"]]`);const l=await Q.get(t);if(l&&l.data){let a=l.data.map(s=>({...s,key:s.name}));for(let s=0;s<a.length;s++){let c=`/api/resource/VGM_Product?fields=["name","product_code","product_name"]&&filters=[["category","=","${a[s].name}"]]`,m=await Q.get(c);if(m!=null&&m.data!=null){a[s].product_num=m.data.length;let P=m.data.map(Y=>({...Y,key:Y.name}));a[s].products=P}else a[s].product_num=0,a[s].products=[]}K(a)}},ce=t=>{M(t.target.value)},re=t=>{const l=t.target.value.toLowerCase();z(l);const a=[...D];if(l===""){_(D);return}else{const s=a.filter(c=>c.product_name.toLowerCase().includes(l));_(s)}},U=(t,l)=>{C(t)},G=(t,l)=>{const a=D.map((s,c)=>{const m=t.indexOf(s.name),P=m!==-1?m+1:null;return{...s,sequence_product:P}});_(a),k(t)},ge={selectedRowKeys:f,onChange:U},ye={selectedProductRowKeys:j,onChange:G},Se=()=>{let t=[],l=[];for(let a=0;a<f.length;a++){let s=E.filter(c=>c.name===f[a]);if(s!=null&&s.length>0){s[0].stt=t.length+1;let c={...s[0]};c.products=c.products.map(m=>({...m,cate_name:c.category_name,product_num:"1"})),l=l.concat(c.products),t.push(c)}}d(l),_(l),T(l),o(t),p(t),x(t),le()},fe=()=>{const t=A.filter(s=>j.includes(s.name));let l=t.map(s=>s.name);u(l);const a=t.sort((s,c)=>{const m=parseInt(s.sequence_product),P=parseInt(c.sequence_product);return m-P});h(a),de()},Ce=f.length>0,je=j.length>0,ke=()=>{g(!0)},_e=()=>{I(!0)},be=()=>{g(!1)},le=()=>{g(!1)},de=()=>{I(!1)},we=t=>{const l=r.filter(c=>c.name!==t.name).map((c,m)=>({...c,stt:m+1})),a=H.filter(c=>c.cate_name!==t.category_name);if(d(a),_(a),q.length>0){const c=q.filter(Y=>Y.cate_name!==t.category_name);let m=1;const P=c.map(Y=>(Y.sequence_product=m++,Y));h(P)}T(a),o(l);const s=l.map(c=>({...c,products:c.products.filter(m=>H.some(P=>P.name===m.name))}));x(s)},Pe=t=>{t.stopPropagation(),$(t.target.checked),b(t.target.checked)},ve=t=>{O(t.target.checked),S(t.target.checked)},Ne=(t,l)=>{const a=[{title:"Mã sản phẩm",dataIndex:"product_code",key:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name",key:"product_name"}];return e.jsx(e.Fragment,{children:e.jsx("div",{style:{margin:5},children:e.jsx(Ke,{columns:a,dataSource:t.products,pagination:!1})})})},Ie=[{title:"STT",dataIndex:"stt",key:"stt"},{title:"Danh mục sản phẩm",dataIndex:"category_name",key:"category_name"},{title:"Số lượng sản phẩm",dataIndex:"product_num",key:"product_num"},{title:"",key:"",render:t=>e.jsx(se,{onClick:()=>we(t)})}],Te=[{title:"Mã sản phẩm",dataIndex:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Danh mục",dataIndex:"cate_name"},{title:"Số lượng ít nhất",dataIndex:"product_num",render:(t,l,a)=>e.jsx(J,{style:{width:"120px"},min:1,defaultValue:t,onChange:s=>{const c=parseInt(s.target.value);!isNaN(c)&&c>=1?ie(a,c):(R.warning("Số lượng ít nhất là 1"),ie(a,1))}})},{title:"",key:"",render:t=>e.jsx(se,{onClick:()=>Ee(t)})}],Ee=t=>{const l=H.filter(s=>s.name!==t.name);d(l);const a=i.map(s=>({...s,products:s.products.filter(c=>l.some(m=>m.name===c.name))}));p(a),x(a)},De=[{key:"sort"},{title:"STT",dataIndex:"sequence_product"},{title:"Mã sản phẩm",dataIndex:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name"},{title:"Danh mục",dataIndex:"cate_name"}],ie=(t,l)=>{const a=[...H];a[t].product_num=l,d(a);const s=i.map(c=>({...c,products:c.products.filter(m=>a.some(P=>P.name===m.name))}));p(s),x(s)},qe=(t,l)=>{_(a=>a.map((s,c)=>{if(c===t){const m=s.sequence_product||0;return{...s,sequence_product:m+l}}return s}))},Oe=t=>{let l=t.map(a=>a.name);ae(l),u(l)},Fe=[{key:"1",label:e.jsxs(pe,{checked:y,onClick:t=>{t.stopPropagation()},onChange:Pe,children:[" ",e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},onClick:t=>{t.stopPropagation()},children:[" ","1. Tiêu chí tồn tại sản phẩm"]})," "]}),children:e.jsx("div",{className:"m-3",children:e.jsx(V,{columns:Te,dataSource:H})})},{key:"2",label:e.jsxs(pe,{onClick:t=>{t.stopPropagation()},checked:B,onChange:ve,children:[" ",e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},onClick:t=>{t.stopPropagation()},children:[" ","2. Tiêu chí sắp xếp sản phẩm"]})," "]}),children:e.jsxs("div",{children:[e.jsxs("div",{onClick:_e,className:"flex justify-center h-9 cursor-pointer items-center ml-4 mt-4 mb-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px] ",children:[e.jsx("p",{className:"mr-2",children:e.jsx(X,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn sản phẩm"})]}),e.jsx("div",{className:"ml-4 mb-4 mr-4 mt-4",style:{fontSize:"17px",fontStyle:"italic",fontWeight:400,lineHeight:"21px",letterSpacing:"0em",textAlign:"left",color:"rgba(99, 115, 129, 1)"},children:e.jsx("span",{children:"Di chuyển (kéo, thả) các sản phẩm để sắp xếp thứ tự sản phẩm"})}),e.jsx(Le,{columnsTable:De,datasTable:q,keyPros:"sequence_product",onDragRowEvent:Oe})]})}],Ae=[{key:"1",label:e.jsxs("span",{style:{fontWeight:700,fontSize:"15px"},children:[" ","Thiết lập tiêu chí chấm điểm trưng bày sản phẩm"]}),children:e.jsx(he,{items:Fe,defaultActiveKey:["1","2"],className:"custom-collapse-audit"})}],Me=t=>{};return e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách sản phẩm"}),e.jsxs("div",{onClick:ke,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(X,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn danh mục"})]}),e.jsxs("div",{className:"pt-6 mx-4",children:[e.jsx(V,{columns:Ie,expandable:{expandedRowRender:Ne,defaultExpandedRowKeys:["0"]},dataSource:r}),e.jsx(he,{items:Ae,defaultActiveKey:["1","2"],onChange:Me,className:"custom-collapse-parent"})]}),e.jsxs(ee,{width:990,title:"Chọn danh mục sản phẩm",open:v,onOk:be,onCancel:le,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(F,{className:"w-[320px] border-none pt-4",children:e.jsx(J,{value:w,onChange:ce,placeholder:"Tìm kiếm danh mục sản phẩm",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:Ce?`Đã chọn ${f.length} danh mục`:""}),e.jsx(ne,{type:"primary",onClick:Se,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(V,{rowSelection:ge,columns:[{title:"Danh mục sản phẩm",dataIndex:"category_name",key:"category_name"},{title:"Số lượng sản phẩm",dataIndex:"product_num",key:"product_num"}],dataSource:E})})]}),e.jsxs(ee,{width:990,title:"Sắp xếp sản phẩm",open:N,onCancel:de,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(F,{className:"w-[320px] border-none pt-4",children:e.jsx(J,{value:L,onChange:re,placeholder:"Tìm kiếm sản phẩm",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:je?`Đã chọn ${j.length} sản phẩm`:""}),e.jsx(ne,{type:"primary",onClick:fe,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(V,{rowSelection:ye,scroll:{y:350},columns:[{title:"Mã sản phẩm",dataIndex:"product_code",key:"product_code"},{title:"Tên sản phẩm",dataIndex:"product_name",key:"product_name"},{title:"Danh mục",dataIndex:"cate_name",key:"cate_name"},{title:"Chọn thứ tự",dataIndex:"sequence_product",render:(t,l,a)=>e.jsx(J,{style:{width:"120px"},defaultValue:t,value:t,onChange:s=>qe(a,parseInt(s.target.value))})}],dataSource:A})})]})]})}function Ze({onChangeCustomer:x}){const[b,S]=n.useState(!1),[u,v]=n.useState([]),[g,N]=n.useState([]),[I,f]=n.useState([]),[C,j]=n.useState([]),[k,E]=n.useState(""),K=[{title:"ID",dataIndex:"customer_code",key:"customer_code"},{title:"Tên khách hàng",key:"customer_name",dataIndex:"customer_name"},{title:"Nhóm khách hàng",dataIndex:"customer_group",key:"customer_group"},{title:"Địa chỉ",key:"customer_primary_address",dataIndex:"customer_primary_address"},{title:"",key:"action",render:(r,o)=>e.jsx("a",{children:e.jsx(se,{onClick:()=>M(o)})})}];n.useEffect(()=>{A()},[]),n.useEffect(()=>{let r=I;k!=null&&k!=""&&(r=I.filter(o=>o.customer_name.toLowerCase().includes(k.toLowerCase()))),N(r)},[k]);const A=async()=>{let o=await Q.get("/api/method/mbw_dms.api.selling.customer.list_customer"),i=[];o!=null&&o.message=="ok"&&(i=o.result.data.map(p=>({...p,key:p.name}))),N(i),f(i)},_=()=>{S(!0)},D=()=>{S(!1)},T=()=>{S(!1)},q=r=>{E(r.target.value)},h=r=>{v(r)},w=()=>{let r=[];for(let o=0;o<u.length;o++){let i=g.filter(p=>p.name==u[o]);i!=null&&i.length>0&&r.push(i[0])}j(r),x(r),T()},M=r=>{const o=C.filter(i=>i.name!==r.name);j(o),x(o)},L={selectedRowKeys:u,onChange:h},z=u.length>0;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách khách hàng"}),e.jsxs("div",{onClick:_,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(X,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn khách hàng"})]}),e.jsx("div",{className:"pt-6 mx-4",children:e.jsx(V,{columns:K,dataSource:C})}),e.jsxs(ee,{width:990,title:"Chọn khách hàng",open:b,onOk:D,onCancel:T,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(F,{className:"w-[320px] border-none pt-4",children:e.jsx(J,{value:k,onChange:q,placeholder:"Tìm kiếm tên khách hàng",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:z?`Đã chọn ${u.length} khách hàng`:""}),e.jsx(ne,{type:"primary",onClick:w,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(V,{rowSelection:L,columns:[{title:"ID",dataIndex:"customer_code",key:"customer_code"},{title:"Tên khách hàng",key:"customer_name",dataIndex:"customer_name"},{title:"Nhóm khách hàng",dataIndex:"customer_group",key:"customer_group"},{title:"Địa chỉ",key:"customer_primary_address",dataIndex:"customer_primary_address"}],dataSource:g})})]})]})})}const Ue=[{title:"Mã nhân viên",dataIndex:"name",key:"name"},{title:"Tên nhân viên",dataIndex:"employee_name",key:"employee_name"},{title:"Email",dataIndex:"email",key:"email"}];function Xe({onChangeEmployees:x}){const[b,S]=n.useState(!1),[u,v]=n.useState([]),[g,N]=n.useState([]),[I,f]=n.useState([]),[C,j]=n.useState(""),[k,E]=n.useState([]),K=[{title:"Mã nhân viên",dataIndex:"name",key:"name"},{title:"Tên nhân viên",dataIndex:"employee_name",key:"employee_name"},{title:"Email",dataIndex:"email",key:"email"},{title:"",key:"",render:r=>e.jsx("a",{children:e.jsx(se,{onClick:()=>M(r)})})}];n.useEffect(()=>{A()},[]),n.useEffect(()=>{let r=I;C!=null&&C!=""&&(r=I.filter(o=>o.employee_name.toLowerCase().includes(C.toLowerCase()))),N(r)},[C]);const A=async()=>{let o=await Q.get("/api/method/mbw_service_v2.api.ess.employee.get_list_employee"),i=[];o!=null&&o.result!=null&&o.result.data!=null&&(i=o.result.data.map(p=>({...p,key:p.name}))),N(i),f(i)},_=()=>{S(!0)},D=()=>{S(!1)},T=()=>{S(!1)},q=r=>{v(r)},h=r=>{j(r.target.value)},w=()=>{let r=[];for(let o=0;o<u.length;o++){let i=g.filter(p=>p.name==u[o]);i!=null&&i.length>0&&r.push(i[0])}E(r),x(r),T()},M=r=>{const o=k.filter(i=>i.name!==r.name);E(o),x(o)},L={selectedRowKeys:u,onChange:q},z=u.length>0;return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"pt-4",children:[e.jsx("p",{className:"ml-4 font-semibold text-sm text-[#212B36]",children:"Danh sách nhân viên"}),e.jsxs("div",{onClick:_,className:"flex justify-center h-9 cursor-pointer items-center ml-4 border-solid border-[1px] border-indigo-600 rounded-xl w-[160px]",children:[e.jsx("p",{className:"mr-2",children:e.jsx(X,{})}),e.jsx("p",{className:"text-sm font-bold text-[#1877F2]",children:"Chọn nhân viên"})]}),e.jsx("div",{className:"pt-6 mx-4",children:e.jsx(V,{columns:K,dataSource:k})}),e.jsxs(ee,{width:990,title:"Chọn nhân viên",open:b,onOk:D,onCancel:T,footer:!1,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(F,{className:"w-[320px] border-none pt-4",children:e.jsx(J,{value:C,onChange:h,placeholder:"Tìm kiếm tên nhân viên",prefix:e.jsx(te,{})})}),e.jsxs("div",{children:[e.jsx("span",{style:{marginRight:8},children:z?`Đã chọn ${u.length} nhân viên`:""}),e.jsx(ne,{type:"primary",onClick:w,children:"Thêm"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(V,{rowSelection:L,columns:Ue,dataSource:g})})]})]})})}function et(){const x=ze(),[b]=xe.useForm(),[S,u]=n.useState("Open"),[v,g]=n.useState([]),[N,I]=n.useState([]),[f,C]=n.useState([]),[j,k]=n.useState({}),[E,K]=n.useState(!0),[A,_]=n.useState(!1),[D,T]=n.useState([]),[q,h]=n.useState(!1),w=async()=>{try{h(!0);let d=b.getFieldsValue(),y=M(d.campaign_start),$=M(d.campaign_end);if(y>=$){R.error("Thời gian bắt đầu phải nhỏ hơn Thời gian kết thúc"),h(!1);return}let B={},O=Object.getOwnPropertyNames(j);if(E&&(B.min_product=j.min_product),A&&(B.sequence_product=D),v.length===0){R.error("Vui lòng điền thông tin sản phẩm"),h(!1);return}if(N.length===0){R.error("Vui lòng chọn ít nhất một nhân viên."),h(!1);return}if(f.length===0){R.error("Vui lòng chọn ít nhất một khách hàng."),h(!1);return}let oe=v.map(G=>G.name),ae=N.map(G=>G.name),Z=f.map(G=>G.name),ce="/api/resource/VGM_Campaign",re={campaign_name:d.campaign_name,campaign_description:d.campaign_description,start_date:y,end_date:$,campaign_status:S,categories:JSON.stringify(oe),employees:JSON.stringify(ae),retails:JSON.stringify(Z),setting_score_audit:B},U=await Q.post(ce,re);U!=null&&U.data!=null?(R.success("Thêm mới thành công"),h(!1),x("/campaign")):(R.error("Thêm mới thất bại"),h(!1))}catch{R.error("Không thể thêm mới. Vui lòng kiểm tra lại thông tin thời gian, sản phẩm, nhân viên, khách hàng"),h(!1)}},M=d=>{const y=new Date(d),$=Ge(y).format("YYYY-MM-DD HH:mm:ss");return y.toISOString().slice(0,19).replace("T"," "),$},L=d=>{u(d)},z=d=>{g(d);const y={};d.forEach(B=>{B.products.forEach(O=>{y.hasOwnProperty(O.key)?y[O.key]=Math.min(y[O.key],parseInt(O.product_num)):y[O.key]=parseInt(O.product_num)})}),k({min_product:y})},r=d=>{I(d)},o=d=>{C(d)},i=d=>{K(d)},p=d=>{_(d)},H=d=>{T(d)};return e.jsxs(e.Fragment,{children:[e.jsx(He,{title:"Thêm mới chiến dịch",icon:e.jsx("p",{onClick:()=>x("/campaign"),className:"mr-2 cursor-pointer",children:e.jsx($e,{})}),buttons:[{label:"Thêm mới",type:"primary",size:"20px",className:"flex items-center",loading:q,action:w}]}),e.jsx("div",{className:"bg-white pt-4 rounded-xl border-[#DFE3E8] border-[0.2px] border-solid",children:e.jsx(xe,{layout:"vertical",form:b,children:e.jsx(Be,{defaultActiveKey:"1",items:[{label:e.jsx("p",{className:"px-4 mb-0",children:" Thông tin chung"}),key:"1",children:e.jsx(We,{form:b,onCampaignStatusChange:L})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Sản phẩm"}),key:"2",children:e.jsx(Qe,{onChangeCategory:z,onChangeCheckExistProduct:i,onChangeCheckSequenceProduct:p,onChangeSequenceProducts:H})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Nhân viên bán hàng"}),key:"3",children:e.jsx(Xe,{onChangeEmployees:r})},{label:e.jsx("p",{className:"px-4 mb-0",children:"Khách hàng"}),key:"4",children:e.jsx(Ze,{onChangeCustomer:o})}],indicatorSize:d=>d-18})})})]})}function nt(){return e.jsxs(e.Fragment,{children:[e.jsx(Ye,{children:e.jsx("title",{children:" Campaign Create"})}),e.jsx(et,{})]})}export{nt as default};
